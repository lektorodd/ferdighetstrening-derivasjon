<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ferdighetstrening Derivasjon</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: JetBrains Mono & Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- MathJax -->
    <script>
        MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']]
            },
            svg: { fontCache: 'global' }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { font-family: 'Inter', sans-serif; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .chart-wrapper { position: relative; height: 250px; width: 100%; }
        
        .filter-checkbox:checked + div {
            background-color: #dbeafe; 
            border-color: #2563eb; 
            color: #1e40af; 
        }
        
        /* Custom select - FIX: appearance: none removes default arrow */
        select {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }
    </style>
</head>
<body class="bg-stone-50 text-stone-800 h-screen flex flex-col overflow-hidden">

    <!-- TOP NAVIGATION -->
    <header class="bg-white border-b border-stone-200 shadow-sm z-20 flex-none">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex justify-between items-center">
            <div class="flex items-center gap-3 cursor-pointer" onclick="navigateTo('dashboard')">
                <div class="bg-blue-600 text-white p-2 rounded-lg">
                    <i class="fa-solid fa-graduation-cap"></i>
                </div>
                <h1 class="text-xl font-bold tracking-tight text-stone-900">Ferdighetstrening <span class="text-blue-600">Derivasjon</span></h1>
            </div>
            <div class="flex space-x-2 bg-stone-100 p-1 rounded-lg">
                <button onclick="setLanguage('no')" id="btn-no" class="lang-btn px-3 py-1 text-sm font-medium rounded-md transition-all">üá≥üá¥</button>
                <button onclick="setLanguage('en')" id="btn-en" class="lang-btn px-3 py-1 text-sm font-medium rounded-md transition-all">üá¨üáß</button>
                <button onclick="setLanguage('es')" id="btn-es" class="lang-btn px-3 py-1 text-sm font-medium rounded-md transition-all">üá™üá∏</button>
                <button onclick="setLanguage('uk')" id="btn-uk" class="lang-btn px-3 py-1 text-sm font-medium rounded-md transition-all">üá∫üá¶</button>
            </div>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        <!-- SIDEBAR NAVIGATION -->
        <nav class="hidden md:flex flex-col w-64 bg-white border-r border-stone-200 pt-6">
            <div class="flex-1 px-4 space-y-2">
                <button onclick="navigateTo('dashboard')" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-lg transition-colors" id="nav-dashboard">
                    <i class="fa-solid fa-house w-5 text-center"></i>
                    <span data-key="nav_dashboard">Oversikt</span>
                </button>
                <button onclick="navigateTo('theory')" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-lg transition-colors" id="nav-theory">
                    <i class="fa-solid fa-book-open w-5 text-center"></i>
                    <span data-key="nav_theory">Teoribank</span>
                </button>
                <button onclick="navigateTo('practice')" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-lg transition-colors" id="nav-practice">
                    <i class="fa-solid fa-dumbbell w-5 text-center"></i>
                    <span data-key="nav_practice">Treningsarena</span>
                </button>
                <button onclick="navigateTo('stats')" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-lg transition-colors" id="nav-stats">
                    <i class="fa-solid fa-chart-simple w-5 text-center"></i>
                    <span data-key="nav_stats">Min Statistikk</span>
                </button>
                <button onclick="navigateTo('help')" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-lg transition-colors" id="nav-help">
                    <i class="fa-solid fa-circle-question w-5 text-center"></i>
                    <span data-key="nav_help">Hjelp</span>
                </button>
            </div>

            <!-- FOOTER -->
            <div class="p-4 mt-auto border-t border-stone-100">
                <p class="font-mono text-xs text-stone-500 leading-tight">Torodd F. Ottestad</p>
                <a href="https://lektorodd.no" target="_blank" class="font-mono text-xs text-blue-600 hover:text-blue-800 hover:underline leading-tight">lektorodd</a>
            </div>
        </nav>

        <!-- MAIN CONTENT AREA -->
        <main class="flex-1 overflow-y-auto bg-stone-50 p-4 sm:p-8 relative" id="main-container">
            
            <!-- VIEW: DASHBOARD -->
            <div id="view-dashboard" class="view-section fade-in">
                <div class="max-w-5xl mx-auto">
                    <h2 class="text-2xl font-bold text-stone-900 mb-2" data-key="dash_welcome">Velkommen!</h2>
                    <p class="text-stone-500 mb-8" data-key="dash_subtitle">Hva vil du trene p√• i dag?</p>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <!-- Card: Smart Mix -->
                        <div onclick="startMixMode()" class="bg-gradient-to-br from-indigo-500 to-purple-600 rounded-2xl p-8 text-white shadow-lg cursor-pointer hover:shadow-xl hover:scale-[1.02] transition-all group relative overflow-hidden">
                            <div class="absolute top-0 right-0 p-8 opacity-20 transform translate-x-4 -translate-y-4">
                                <i class="fa-solid fa-shuffle text-9xl"></i>
                            </div>
                            <div class="relative z-10 h-full flex flex-col">
                                <div class="bg-white/20 w-12 h-12 rounded-lg flex items-center justify-center mb-6 group-hover:bg-white/30 transition-colors">
                                    <i class="fa-solid fa-brain text-2xl"></i>
                                </div>
                                <h3 class="text-2xl font-bold mb-2" data-key="mode_mix_title">Smart Miks</h3>
                                <p class="text-indigo-100 mb-8 flex-grow" data-key="mode_mix_desc">Algoritmen finner dine svake sider og gir deg en blanding.</p>
                                <div class="flex items-center font-bold bg-white/10 self-start px-4 py-2 rounded-lg backdrop-blur-sm group-hover:bg-white/20 transition-colors">
                                    <span data-key="btn_start_mix">Start Trening</span> <i class="fa-solid fa-arrow-right ml-2"></i>
                                </div>
                            </div>
                        </div>

                        <!-- Card: Focus Mode -->
                        <div onclick="startFocusMode()" class="bg-white rounded-2xl p-8 text-stone-800 shadow-lg border border-stone-200 cursor-pointer hover:shadow-xl hover:border-blue-300 hover:scale-[1.02] transition-all group relative overflow-hidden">
                            <div class="absolute top-0 right-0 p-8 opacity-5 transform translate-x-4 -translate-y-4">
                                <i class="fa-solid fa-crosshairs text-9xl text-blue-900"></i>
                            </div>
                            <div class="relative z-10 h-full flex flex-col">
                                <div class="bg-blue-50 w-12 h-12 rounded-lg flex items-center justify-center mb-6 text-blue-600 group-hover:bg-blue-100 transition-colors">
                                    <i class="fa-solid fa-list-check text-2xl"></i>
                                </div>
                                <h3 class="text-2xl font-bold mb-2" data-key="dash_focus_header">Fokustrening</h3>
                                <p class="text-stone-500 mb-8 flex-grow" data-key="dash_focus_desc">Velg selv regel, niv√• og type. Perfekt for mengdetrening.</p>
                                <div class="flex items-center font-bold text-blue-600 self-start px-4 py-2 rounded-lg bg-blue-50 group-hover:bg-blue-100 transition-colors">
                                    <span data-key="btn_start_focus">G√• til Fokus</span> <i class="fa-solid fa-arrow-right ml-2"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VIEW: THEORY -->
            <div id="view-theory" class="view-section hidden fade-in">
                <div class="max-w-3xl mx-auto">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold text-stone-900" data-key="nav_theory">Teoribank</h2>
                        <select id="theory-topic-select" onchange="renderTheory()" class="bg-white border border-stone-300 text-stone-700 text-sm rounded-lg block p-2">
                            <option value="chain" data-key="topic_chain">Kjerneregelen</option>
                            <option value="product" data-key="topic_product">Produktregelen</option>
                            <option value="quotient" data-key="topic_quotient">Br√∏kregelen</option>
                        </select>
                    </div>
                    <div id="theory-content" class="bg-white rounded-xl border border-stone-200 shadow-sm p-8"></div>
                </div>
            </div>

            <!-- VIEW: PRACTICE -->
            <div id="view-practice" class="view-section hidden fade-in">
                <div class="max-w-3xl mx-auto">
                    <div class="flex justify-between items-end mb-4">
                        <h2 class="text-2xl font-bold text-stone-900" id="practice-title">Treningsarena</h2>
                        <div class="flex bg-white border border-stone-200 rounded-lg p-1 shadow-sm">
                            <button onclick="setMode('focus')" id="mode-focus-btn" class="px-3 py-1 text-xs font-bold rounded transition-all">Fokus</button>
                            <button onclick="setMode('mix')" id="mode-mix-btn" class="px-3 py-1 text-xs font-bold rounded transition-all">Smart Miks</button>
                        </div>
                    </div>

                    <!-- FOCUS FILTER PANEL -->
                    <div id="focus-filter-panel" class="hidden bg-white p-6 rounded-xl border border-stone-200 shadow-sm mb-8 fade-in">
                        <div class="mb-6">
                            <label class="block text-xs font-bold text-stone-400 uppercase tracking-wider mb-2" data-key="filter_rule">Regel</label>
                            <select id="focus-rule-select" onchange="changeFocusRule(this.value)" class="w-full p-2.5 bg-white border border-stone-300 text-stone-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block shadow-sm">
                                <option value="chain" data-key="topic_chain">Kjerneregelen</option>
                                <option value="product" data-key="topic_product">Produktregelen</option>
                                <option value="quotient" data-key="topic_quotient">Br√∏kregelen</option>
                            </select>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div>
                                <h4 class="text-xs font-bold text-stone-400 uppercase tracking-wider mb-3" data-key="filter_levels">Vanskelighetsgrad</h4>
                                <div class="flex gap-2 flex-wrap">
                                    <label class="cursor-pointer"><input type="checkbox" class="filter-checkbox sr-only" value="1" onchange="toggleFilter('level', 1)" checked><div class="px-3 py-1.5 rounded-md border border-stone-200 text-sm font-medium text-stone-600 hover:bg-stone-50 transition-colors">Niv√• 1</div></label>
                                    <label class="cursor-pointer"><input type="checkbox" class="filter-checkbox sr-only" value="2" onchange="toggleFilter('level', 2)" checked><div class="px-3 py-1.5 rounded-md border border-stone-200 text-sm font-medium text-stone-600 hover:bg-stone-50 transition-colors">Niv√• 2</div></label>
                                    <label class="cursor-pointer"><input type="checkbox" class="filter-checkbox sr-only" value="3" onchange="toggleFilter('level', 3)" checked><div class="px-3 py-1.5 rounded-md border border-stone-200 text-sm font-medium text-stone-600 hover:bg-stone-50 transition-colors">Niv√• 3</div></label>
                                    <label class="cursor-pointer"><input type="checkbox" class="filter-checkbox sr-only" value="4" onchange="toggleFilter('level', 4)" checked><div class="px-3 py-1.5 rounded-md border border-stone-200 text-sm font-medium text-stone-600 hover:bg-stone-50 transition-colors">Niv√• 4</div></label>
                                    <label class="cursor-pointer"><input type="checkbox" class="filter-checkbox sr-only" value="5" onchange="toggleFilter('level', 5)" checked><div class="px-3 py-1.5 rounded-md border border-stone-200 text-sm font-medium text-stone-600 hover:bg-stone-50 transition-colors">Niv√• 5</div></label>
                                </div>
                            </div>
                            <div>
                                <h4 class="text-xs font-bold text-stone-400 uppercase tracking-wider mb-3" data-key="filter_types">Matematisk Omr√•de</h4>
                                <div class="flex gap-2 flex-wrap">
                                    <label class="cursor-pointer"><input type="checkbox" class="filter-checkbox sr-only" value="poly" onchange="toggleFilter('type', 'poly')" checked><div class="px-3 py-1.5 rounded-md border border-stone-200 text-sm font-medium text-stone-600 hover:bg-stone-50 transition-colors" data-key="type_poly">Polynomer</div></label>
                                    <label class="cursor-pointer"><input type="checkbox" class="filter-checkbox sr-only" value="root" onchange="toggleFilter('type', 'root')" checked><div class="px-3 py-1.5 rounded-md border border-stone-200 text-sm font-medium text-stone-600 hover:bg-stone-50 transition-colors" data-key="type_root">R√∏tter</div></label>
                                    <label class="cursor-pointer"><input type="checkbox" class="filter-checkbox sr-only" value="exp" onchange="toggleFilter('type', 'exp')" checked><div class="px-3 py-1.5 rounded-md border border-stone-200 text-sm font-medium text-stone-600 hover:bg-stone-50 transition-colors" data-key="type_exp">Eksponential</div></label>
                                    <label class="cursor-pointer"><input type="checkbox" class="filter-checkbox sr-only" value="log" onchange="toggleFilter('type', 'log')" checked><div class="px-3 py-1.5 rounded-md border border-stone-200 text-sm font-medium text-stone-600 hover:bg-stone-50 transition-colors" data-key="type_log">Logaritmer</div></label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex justify-between items-center border-t border-stone-100 pt-4">
                            <div class="text-xs text-stone-400">
                                <span id="filter-count">0</span> oppgaver tilgjengelig
                            </div>
                            <button onclick="applyFiltersAndDraw()" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-lg font-bold text-sm shadow-sm transition-colors">
                                <i class="fa-solid fa-rotate mr-2"></i> <span data-key="btn_draw_focus">Trekk 5 oppgaver</span>
                            </button>
                        </div>
                    </div>

                    <div id="problems-container" class="space-y-6 pb-12"></div>
                </div>
            </div>

            <!-- VIEW: STATS -->
            <div id="view-stats" class="view-section hidden fade-in">
                <div class="max-w-5xl mx-auto">
                    <h2 class="text-2xl font-bold text-stone-900 mb-6" data-key="nav_stats">Min Statistikk</h2>
                    
                    <!-- Top Metrics -->
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
                        <div class="bg-white p-4 rounded-xl border border-stone-200 shadow-sm flex flex-col items-center justify-center">
                            <span class="text-stone-500 text-xs uppercase font-bold tracking-wider mb-1" data-key="stat_total_attempted">Utf√∏rt</span>
                            <span class="text-3xl font-bold text-stone-800" id="stat-total-display">0</span>
                        </div>
                        <div class="bg-white p-4 rounded-xl border border-stone-200 shadow-sm flex flex-col items-center justify-center">
                            <span class="text-stone-500 text-xs uppercase font-bold tracking-wider mb-1" data-key="stat_mastery_rate">Mestring</span>
                            <span class="text-3xl font-bold text-emerald-600" id="stat-mastery-display">0%</span>
                        </div>
                        <div class="bg-white p-4 rounded-xl border border-stone-200 shadow-sm flex flex-col items-center justify-center">
                            <span class="text-stone-500 text-xs uppercase font-bold tracking-wider mb-1" data-key="stat_hint_usage">Hint</span>
                            <span class="text-3xl font-bold text-amber-500" id="stat-hint-display">0%</span>
                        </div>
                    </div>

                    <!-- Charts Grid -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <!-- Topic Chart -->
                        <div class="bg-white p-6 rounded-xl border border-stone-200 shadow-sm">
                            <h3 class="font-semibold text-stone-800 mb-4" data-key="stat_chart_topic">Ferdighet per Emne</h3>
                            <div class="chart-wrapper"><canvas id="topicChart"></canvas></div>
                        </div>
                        <!-- Level Chart (NEW) -->
                        <div class="bg-white p-6 rounded-xl border border-stone-200 shadow-sm">
                            <h3 class="font-semibold text-stone-800 mb-4" data-key="stat_chart_level">Ferdighet per Niv√•</h3>
                            <div class="chart-wrapper"><canvas id="levelChart"></canvas></div>
                        </div>
                    </div>
                    
                    <!-- Overall Doughnut -->
                    <div class="bg-white p-6 rounded-xl border border-stone-200 shadow-sm max-w-md mx-auto">
                        <h3 class="font-semibold text-stone-800 mb-4 text-center" data-key="stat_chart_total">Total Oversikt</h3>
                        <div class="chart-wrapper"><canvas id="masteryChart"></canvas></div>
                    </div>

                    <!-- Clear Progress Button -->
                    <div class="mt-8 text-center">
                        <button onclick="clearProgress()" class="px-4 py-2 text-sm font-medium text-red-600 bg-red-50 hover:bg-red-100 border border-red-200 rounded-lg transition-colors">
                            <i class="fa-solid fa-trash-can mr-2"></i><span data-key="btn_clear_progress">Nullstill Fremgang</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- VIEW: HELP -->
            <div id="view-help" class="view-section hidden fade-in">
                <div class="max-w-3xl mx-auto bg-white rounded-xl border border-stone-200 shadow-sm p-8">
                    <h2 class="text-2xl font-bold text-stone-900 mb-6" data-key="help_title">Hjelp & Informasjon</h2>
                    
                    <div class="space-y-8">
                        <div>
                            <h3 class="font-bold text-lg text-blue-600 mb-2 flex items-center gap-2"><i class="fa-solid fa-crosshairs"></i> <span data-key="help_focus_title">Fokustrening</span></h3>
                            <p class="text-stone-600 text-sm leading-relaxed" data-key="help_focus_desc">Her kan du skreddersy din egen √∏kt. Velg hvilken regel du vil √∏ve p√• (rullegardin), hvilke vanskelighetsgrader (1-5) og hvilke typer funksjoner. Trykk "Hent oppgaver" for √• generere 5 unike oppgaver som passer dine valg.</p>
                        </div>
                        
                        <div>
                            <h3 class="font-bold text-lg text-purple-600 mb-2 flex items-center gap-2"><i class="fa-solid fa-shuffle"></i> <span data-key="help_mix_title">Smart Miks</span></h3>
                            <p class="text-stone-600 text-sm leading-relaxed" data-key="help_mix_desc">Dette er "den smarte l√¶reren". Algoritmen ser p√• hva du har gjort f√∏r. Hvis du markerer oppgaver som "Trenger √∏ving", vil Smart Miks gi deg flere av disse oppgavene senere. Den prioriterer ogs√• emner du har gjort lite av.</p>
                        </div>

                        <div>
                            <h3 class="font-bold text-lg text-emerald-600 mb-2 flex items-center gap-2"><i class="fa-solid fa-chart-simple"></i> <span data-key="help_stats_title">Statistikk & Progresjon</span></h3>
                            <p class="text-stone-600 text-sm leading-relaxed" data-key="help_stats_desc">"Mestret" betyr at du f√∏ler deg trygg p√• oppgaven. "Trenger √∏ving" betyr at du vil se den igjen senere. Statistikken viser deg hvor du er sterk (niv√•/emne) og hvor du b√∏r legge inn en ekstra innsats.</p>
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- JS LOGIC -->
    <script>
        const state = {
            currentView: 'dashboard',
            language: 'no',
            activeTopic: 'chain',
            mode: 'focus',
            progress: JSON.parse(localStorage.getItem('mathTrainerProgress')) || {},
            hints: JSON.parse(localStorage.getItem('mathTrainerHints')) || [],
            recentlyShown: JSON.parse(localStorage.getItem('mathTrainerRecentlyShown')) || [],
            activeProblems: [],
            filters: {
                levels: [1, 2, 3, 4, 5],
                types: ['poly', 'root', 'exp', 'log']
            }
        };

        const i18n = {
            no: {
                nav_dashboard: "Oversikt",
                nav_theory: "Teoribank",
                nav_practice: "Treningsarena",
                nav_stats: "Min Statistikk",
                nav_help: "Hjelp",
                dash_welcome: "Velkommen!",
                dash_subtitle: "Hva vil du trene p√• i dag?",
                dash_focus_header: "Fokustrening",
                dash_focus_desc: "Velg selv regel, niv√• og type. Perfekt for mengdetrening.",
                mode_mix_title: "Smart Miks",
                mode_mix_desc: "Algoritmen finner dine svake sider.",
                topic_chain: "Kjerneregelen",
                topic_product: "Produktregelen",
                topic_quotient: "Br√∏kregelen",
                btn_start_focus: "G√• til Fokus",
                btn_start_mix: "Start Trening",
                btn_solution: "Vis Fasit",
                btn_hide: "Skjul Fasit",
                btn_mastered: "Fikk det til",
                btn_practice: "Trenger √∏ving",
                chart_mastered: "Mestret",
                chart_practice: "M√• √∏ves",
                chart_pending: "Ikke startet",
                theory_formula: "Formel",
                theory_explanation: "Forklaring",
                practice_subtitle_mix: "Smart Miks - Tilpasset deg",
                btn_hint: "Hint",
                btn_hide_hint: "Skjul Hint",
                label_mix: "???",
                hint_title: "Hjelp p√• veien",
                label_recommended: "Anbefalt",
                btn_new_mix: "Pr√∏v 5 nye oppgaver",
                mix_end_text: "Ferdig med denne runden?",
                stat_total_attempted: "Utf√∏rt",
                stat_mastery_rate: "Mestring",
                stat_hint_usage: "Hint Brukt",
                stat_chart_total: "Total Oversikt",
                stat_chart_topic: "Ferdighet per Emne",
                stat_chart_level: "Ferdighet per Niv√•",
                filter_rule: "Regel",
                filter_levels: "Niv√•",
                filter_types: "Matematisk Omr√•de",
                type_poly: "Polynomer",
                type_root: "R√∏tter",
                type_exp: "Eksponential",
                type_log: "Logaritmer",
                btn_draw_focus: "Trekk 5 oppgaver",
                focus_end_text: "Vil du ha flere av samme type?",
                btn_new_focus: "Trekk 5 nye (samme filtre)",
                help_title: "Hjelp & Informasjon",
                help_focus_title: "Fokustrening",
                help_focus_desc: "Her kan du skreddersy din egen √∏kt. Velg hvilken regel du vil √∏ve p√•, niv√• og type. Systemet genererer nye oppgaver hver gang.",
                help_mix_title: "Smart Miks",
                help_mix_desc: "Algoritmen l√¶rer av dine svar. Den gir deg oppgaver du trenger √• √∏ve mer p√•, samt en god blanding av repetisjon.",
                help_stats_title: "Statistikk",
                help_stats_desc: "F√• oversikt over fremgangen din fordelt p√• emne og vanskelighetsgrad.",
                btn_clear_progress: "Nullstill Fremgang",
                clear_confirm: "Er du sikker p√• at du vil slette all fremgang? Dette kan ikke angres."
            },
            en: {
                nav_dashboard: "Dashboard",
                nav_theory: "Theory Bank",
                nav_practice: "Practice Arena",
                nav_stats: "My Stats",
                nav_help: "Help",
                dash_welcome: "Welcome!",
                dash_subtitle: "What to practice today?",
                dash_focus_header: "Focus Training",
                dash_focus_desc: "Choose rule, level and type yourself.",
                mode_mix_title: "Smart Mix",
                mode_mix_desc: "The algorithm finds your weak spots.",
                topic_chain: "Chain Rule",
                topic_product: "Product Rule",
                topic_quotient: "Quotient Rule",
                btn_start_focus: "Go to Focus",
                btn_start_mix: "Start Training",
                btn_solution: "Show Answer",
                btn_hide: "Hide Answer",
                btn_mastered: "Got it!",
                btn_practice: "Need Practice",
                chart_mastered: "Mastered",
                chart_practice: "Needs Work",
                chart_pending: "Not Started",
                theory_formula: "Formula",
                theory_explanation: "Explanation",
                practice_subtitle_mix: "Smart Mix - Adaptive",
                btn_hint: "Hint",
                btn_hide_hint: "Hide Hint",
                label_mix: "???",
                hint_title: "Quick Tip",
                label_recommended: "Recommended",
                btn_new_mix: "Try 5 New Tasks",
                mix_end_text: "Done with this set?",
                stat_total_attempted: "Completed",
                stat_mastery_rate: "Mastery",
                stat_hint_usage: "Hint Usage",
                stat_chart_total: "Progress",
                stat_chart_topic: "Skill per Topic",
                stat_chart_level: "Skill per Level",
                filter_rule: "Rule",
                filter_levels: "Levels",
                filter_types: "Math Area",
                type_poly: "Polynomials",
                type_root: "Roots",
                type_exp: "Exponential",
                type_log: "Logarithms",
                btn_draw_focus: "Draw 5 Problems",
                focus_end_text: "Want more of the same?",
                btn_new_focus: "Draw 5 New (Same Filters)",
                help_title: "Help & Info",
                help_focus_title: "Focus Training",
                help_focus_desc: "Tailor your session. Choose rule, level, and type. The system generates unique problems every time.",
                help_mix_title: "Smart Mix",
                help_mix_desc: "The algorithm learns from you, prioritizing tasks you need to practice.",
                help_stats_title: "Statistics",
                help_stats_desc: "Track your mastery across topics and difficulty levels.",
                btn_clear_progress: "Clear Progress",
                clear_confirm: "Are you sure you want to delete all progress? This cannot be undone."
            },
            es: {
                nav_dashboard: "Tablero",
                nav_theory: "Teor√≠a",
                nav_practice: "Arena de Pr√°ctica",
                nav_stats: "Mis Estad√≠sticas",
                nav_help: "Ayuda",
                dash_welcome: "¬°Bienvenido!",
                dash_subtitle: "¬øQu√© quieres practicar?",
                dash_focus_header: "Entrenamiento Enfocado",
                dash_focus_desc: "Elige regla, nivel y tipo t√∫ mismo.",
                mode_mix_title: "Mezcla Inteligente",
                mode_mix_desc: "El algoritmo encuentra tus debilidades.",
                topic_chain: "Regla de la Cadena",
                topic_product: "Regla del Producto",
                topic_quotient: "Regla del Cociente",
                btn_start_focus: "Ir a Enfoque",
                btn_start_mix: "Empezar",
                btn_solution: "Ver Soluci√≥n",
                btn_hide: "Ocultar Soluci√≥n",
                btn_mastered: "¬°Lo tengo!",
                btn_practice: "Necesito Pr√°ctica",
                chart_mastered: "Dominado",
                chart_practice: "Necesita Pr√°ctica",
                chart_pending: "Pendiente",
                theory_formula: "F√≥rmula",
                theory_explanation: "Explicaci√≥n",
                practice_subtitle_mix: "Mezcla Inteligente",
                btn_hint: "Pista",
                btn_hide_hint: "Ocultar Pista",
                label_mix: "???",
                hint_title: "Pista",
                label_recommended: "Recomendado",
                btn_new_mix: "Prueba 5 Nuevas",
                mix_end_text: "¬øTerminaste?",
                stat_total_attempted: "Completado",
                stat_mastery_rate: "Dominio",
                stat_hint_usage: "Pistas",
                stat_chart_total: "Progreso",
                stat_chart_topic: "Habilidad por Tema",
                stat_chart_level: "Habilidad por Nivel",
                filter_rule: "Regla",
                filter_levels: "Niveles",
                filter_types: "√Årea Matem√°tica",
                btn_draw_focus: "Extraer 5 problemas",
                focus_end_text: "¬øQuieres m√°s?",
                btn_new_focus: "Extraer 5 nuevas",
                help_title: "Ayuda e Informaci√≥n",
                help_focus_title: "Entrenamiento Enfocado",
                help_focus_desc: "Personaliza tu sesi√≥n. Elige regla, nivel y tipo.",
                help_mix_title: "Mezcla Inteligente",
                help_mix_desc: "El algoritmo aprende de ti, priorizando lo que necesitas practicar.",
                help_stats_title: "Estad√≠sticas",
                help_stats_desc: "Rastrea tu dominio por tema y nivel.",
                btn_clear_progress: "Borrar Progreso",
                clear_confirm: "¬øEst√°s seguro de que quieres eliminar todo el progreso? Esto no se puede deshacer."
            },
            uk: {
                nav_dashboard: "–û–≥–ª—è–¥",
                nav_theory: "–ë–∞–Ω–∫ –¢–µ–æ—Ä—ñ—ó",
                nav_practice: "–ê—Ä–µ–Ω–∞ –ü—Ä–∞–∫—Ç–∏–∫–∏",
                nav_stats: "–ú–æ—è –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞",
                nav_help: "–î–æ–ø–æ–º–æ–≥–∞",
                dash_welcome: "–õ–∞—Å–∫–∞–≤–æ –ø—Ä–æ—Å–∏–º–æ!",
                dash_subtitle: "–©–æ –≤–∏ —Ö–æ—á–µ—Ç–µ —Ç—Ä–µ–Ω—É–≤–∞—Ç–∏ —Å—å–æ–≥–æ–¥–Ω—ñ?",
                dash_focus_header: "–§–æ–∫—É—Å–Ω–µ –¢—Ä–µ–Ω—É–≤–∞–Ω–Ω—è",
                dash_focus_desc: "–í–∏–±–µ—Ä—ñ—Ç—å –ø—Ä–∞–≤–∏–ª–æ, —Ä—ñ–≤–µ–Ω—å —ñ —Ç–∏–ø —Å–∞–º–æ—Å—Ç—ñ–π–Ω–æ. –Ü–¥–µ–∞–ª—å–Ω–æ –¥–ª—è —ñ–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ–≥–æ —Ç—Ä–µ–Ω—É–≤–∞–Ω–Ω—è.",
                mode_mix_title: "–†–æ–∑—É–º–Ω–∏–π –ú—ñ–∫—Å",
                mode_mix_desc: "–ê–ª–≥–æ—Ä–∏—Ç–º –∑–Ω–∞—Ö–æ–¥–∏—Ç—å –≤–∞—à—ñ —Å–ª–∞–±–∫—ñ –º—ñ—Å—Ü—è.",
                topic_chain: "–ü—Ä–∞–≤–∏–ª–æ –õ–∞–Ω—Ü—é–≥–∞",
                topic_product: "–ü—Ä–∞–≤–∏–ª–æ –î–æ–±—É—Ç–∫—É",
                topic_quotient: "–ü—Ä–∞–≤–∏–ª–æ –ß–∞—Å—Ç–∫–∏",
                btn_start_focus: "–ü–µ—Ä–µ–π—Ç–∏ –¥–æ –§–æ–∫—É—Å—É",
                btn_start_mix: "–ü–æ—á–∞—Ç–∏ –¢—Ä–µ–Ω—É–≤–∞–Ω–Ω—è",
                btn_solution: "–ü–æ–∫–∞–∑–∞—Ç–∏ –í—ñ–¥–ø–æ–≤—ñ–¥—å",
                btn_hide: "–ü—Ä–∏—Ö–æ–≤–∞—Ç–∏ –í—ñ–¥–ø–æ–≤—ñ–¥—å",
                btn_mastered: "–ó—Ä–æ–∑—É–º—ñ–≤!",
                btn_practice: "–ü–æ—Ç—Ä—ñ–±–Ω–∞ –ü—Ä–∞–∫—Ç–∏–∫–∞",
                chart_mastered: "–û—Å–≤–æ—î–Ω–æ",
                chart_practice: "–ü–æ—Ç—Ä—ñ–±–Ω–∞ –ü—Ä–∞–∫—Ç–∏–∫–∞",
                chart_pending: "–ù–µ –†–æ–∑–ø–æ—á–∞—Ç–æ",
                theory_formula: "–§–æ—Ä–º—É–ª–∞",
                theory_explanation: "–ü–æ—è—Å–Ω–µ–Ω–Ω—è",
                practice_subtitle_mix: "–†–æ–∑—É–º–Ω–∏–π –ú—ñ–∫—Å - –ê–¥–∞–ø—Ç–∏–≤–Ω–∏–π",
                btn_hint: "–ü—ñ–¥–∫–∞–∑–∫–∞",
                btn_hide_hint: "–ü—Ä–∏—Ö–æ–≤–∞—Ç–∏ –ü—ñ–¥–∫–∞–∑–∫—É",
                label_mix: "???",
                hint_title: "–®–≤–∏–¥–∫–∞ –ü—ñ–¥–∫–∞–∑–∫–∞",
                label_recommended: "–†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ",
                btn_new_mix: "–°–ø—Ä–æ–±—É–≤–∞—Ç–∏ 5 –ù–æ–≤–∏—Ö –ó–∞–≤–¥–∞–Ω—å",
                mix_end_text: "–ó–∞–∫—ñ–Ω—á–∏–ª–∏ –∑ —Ü–∏–º –Ω–∞–±–æ—Ä–æ–º?",
                stat_total_attempted: "–í–∏–∫–æ–Ω–∞–Ω–æ",
                stat_mastery_rate: "–†—ñ–≤–µ–Ω—å –ú–∞–π—Å—Ç–µ—Ä–Ω–æ—Å—Ç—ñ",
                stat_hint_usage: "–í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –ü—ñ–¥–∫–∞–∑–æ–∫",
                stat_chart_total: "–ó–∞–≥–∞–ª—å–Ω–∏–π –ü—Ä–æ–≥—Ä–µ—Å",
                stat_chart_topic: "–ù–∞–≤–∏—á–∫–∏ –∑–∞ –¢–µ–º–æ—é",
                stat_chart_level: "–ù–∞–≤–∏—á–∫–∏ –∑–∞ –†—ñ–≤–Ω–µ–º",
                filter_rule: "–ü—Ä–∞–≤–∏–ª–æ",
                filter_levels: "–†—ñ–≤–Ω—ñ",
                filter_types: "–ú–∞—Ç–µ–º–∞—Ç–∏—á–Ω–∞ –û–±–ª–∞—Å—Ç—å",
                btn_draw_focus: "–û—Ç—Ä–∏–º–∞—Ç–∏ 5 –ó–∞–¥–∞—á",
                focus_end_text: "–•–æ—á–µ—Ç–µ –±—ñ–ª—å—à–µ —Ç–∞–∫–∏—Ö —Å–∞–º–∏—Ö?",
                btn_new_focus: "–û—Ç—Ä–∏–º–∞—Ç–∏ 5 –ù–æ–≤–∏—Ö (–¢—ñ –∂ –§—ñ–ª—å—Ç—Ä–∏)",
                help_title: "–î–æ–ø–æ–º–æ–≥–∞ —Ç–∞ –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è",
                help_focus_title: "–§–æ–∫—É—Å–Ω–µ –¢—Ä–µ–Ω—É–≤–∞–Ω–Ω—è",
                help_focus_desc: "–ù–∞–ª–∞—à—Ç—É–π—Ç–µ —Å–≤—ñ–π —Å–µ–∞–Ω—Å. –í–∏–±–µ—Ä—ñ—Ç—å –ø—Ä–∞–≤–∏–ª–æ, —Ä—ñ–≤–µ–Ω—å —ñ —Ç–∏–ø. –°–∏—Å—Ç–µ–º–∞ –≥–µ–Ω–µ—Ä—É—î —É–Ω—ñ–∫–∞–ª—å–Ω—ñ –∑–∞–≤–¥–∞–Ω–Ω—è –∫–æ–∂–Ω–æ–≥–æ —Ä–∞–∑—É.",
                help_mix_title: "–†–æ–∑—É–º–Ω–∏–π –ú—ñ–∫—Å",
                help_mix_desc: "–ê–ª–≥–æ—Ä–∏—Ç–º –Ω–∞–≤—á–∞—î—Ç—å—Å—è –Ω–∞ –≤–∞—à–∏—Ö –≤—ñ–¥–ø–æ–≤—ñ–¥—è—Ö, –ø—Ä—ñ–æ—Ä–∏—Ç–∏–∑—É—é—á–∏ –∑–∞–≤–¥–∞–Ω–Ω—è, —è–∫—ñ –≤–∞–º –ø–æ—Ç—Ä—ñ–±–Ω–æ –ø—Ä–∞–∫—Ç–∏–∫—É–≤–∞—Ç–∏.",
                help_stats_title: "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞",
                help_stats_desc: "–í—ñ–¥—Å—Ç–µ–∂—É–π—Ç–µ —Å–≤–æ—é –º–∞–π—Å—Ç–µ—Ä–Ω—ñ—Å—Ç—å –∑–∞ —Ç–µ–º–∞–º–∏ —Ç–∞ —Ä—ñ–≤–Ω—è–º–∏ —Å–∫–ª–∞–¥–Ω–æ—Å—Ç—ñ.",
                btn_clear_progress: "–û—á–∏—Å—Ç–∏—Ç–∏ –ü—Ä–æ–≥—Ä–µ—Å",
                clear_confirm: "–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ –≤–µ—Å—å –ø—Ä–æ–≥—Ä–µ—Å? –¶–µ –Ω–µ –º–æ–∂–Ω–∞ —Å–∫–∞—Å—É–≤–∞—Ç–∏."
            }
        };

        const theoryData = {
            chain: {
                no: {
                    title: "Kjerneregelen",
                    intro: "Kjerneregelen brukes n√•r vi skal derivere sammensatte funksjoner - alts√• funksjoner inne i funksjoner.",
                    formula: "$$f(x) = g(u(x)) \\implies f'(x) = g'(u) \\cdot u'(x)$$",
                    ruleText: "Derivert ytre ¬∑ Derivert kjerne",
                    whenToUse: `
                        <div class="mb-4">
                            <h4 class="font-bold text-stone-700 mb-2">üìå N√•r bruker du kjerneregelen?</h4>
                            <ul class="list-disc list-inside space-y-1 text-stone-600">
                                <li>N√•r du har en <strong>funksjon inne i en annen funksjon</strong></li>
                                <li>N√•r du ser <strong>potenser av uttrykk</strong> som $(2x+1)^3$ eller $(x^2-5)^{10}$</li>
                                <li>N√•r du har <strong>$e^{uttrykk}$</strong> eller <strong>$\\ln(uttrykk)$</strong> hvor "uttrykk" ikke bare er $x$</li>
                                <li>N√•r du har <strong>$\\sqrt{uttrykk}$</strong> hvor uttrykket er mer enn bare $x$</li>
                            </ul>
                        </div>
                    `,
                    detailedExample: `
                        <div class="bg-blue-50/50 p-4 rounded-lg border border-blue-100 mb-4">
                            <h4 class="font-bold text-blue-900 mb-3">üîç Detaljert eksempel: $f(x) = (3x - 2)^4$</h4>

                            <div class="space-y-3 text-sm text-stone-700">
                                <div class="bg-white p-3 rounded border border-blue-100">
                                    <strong class="text-blue-700">Steg 1: Identifiser ytre og indre funksjon</strong>
                                    <div class="mt-2 ml-4">
                                        <p>‚Ä¢ <strong>Ytre funksjon:</strong> $g(u) = u^4$ (noe i 4. potens)</p>
                                        <p>‚Ä¢ <strong>Indre funksjon (kjernen):</strong> $u(x) = 3x - 2$</p>
                                    </div>
                                </div>

                                <div class="bg-white p-3 rounded border border-blue-100">
                                    <strong class="text-blue-700">Steg 2: Deriver ytre funksjonen (la kjernen st√•)</strong>
                                    <div class="mt-2 ml-4">
                                        <p>$g'(u) = 4u^3 = 4(3x-2)^3$</p>
                                        <p class="text-xs text-stone-500 italic mt-1">Bruker potensregelen: $(u^n)' = n \\cdot u^{n-1}$</p>
                                    </div>
                                </div>

                                <div class="bg-white p-3 rounded border border-blue-100">
                                    <strong class="text-blue-700">Steg 3: Deriver kjernen</strong>
                                    <div class="mt-2 ml-4">
                                        <p>$u'(x) = 3$</p>
                                        <p class="text-xs text-stone-500 italic mt-1">Deriverer $3x - 2$ ledd for ledd</p>
                                    </div>
                                </div>

                                <div class="bg-white p-3 rounded border border-blue-100">
                                    <strong class="text-blue-700">Steg 4: Gang sammen (ytre ¬∑ kjerne)</strong>
                                    <div class="mt-2 ml-4">
                                        <p>$$f'(x) = 4(3x-2)^3 \\cdot 3 = 12(3x-2)^3$$</p>
                                    </div>
                                </div>

                                <div class="bg-emerald-50 p-3 rounded border border-emerald-200 mt-3">
                                    <strong class="text-emerald-800">‚úÖ Svar:</strong> $f'(x) = 12(3x-2)^3$
                                </div>
                            </div>
                        </div>
                    `
                },
                en: {
                    title: "Chain Rule",
                    intro: "The chain rule is used when differentiating composite functions - functions within functions.",
                    formula: "$$f(x) = g(u(x)) \\implies f'(x) = g'(u) \\cdot u'(x)$$",
                    ruleText: "Outer deriv ¬∑ Inner deriv",
                    whenToUse: `
                        <div class="mb-4">
                            <h4 class="font-bold text-stone-700 mb-2">üìå When to use the chain rule?</h4>
                            <ul class="list-disc list-inside space-y-1 text-stone-600">
                                <li>When you have a <strong>function inside another function</strong></li>
                                <li>When you see <strong>powers of expressions</strong> like $(2x+1)^3$</li>
                                <li>When you have <strong>$e^{expression}$</strong> or <strong>$\\ln(expression)$</strong> where "expression" is not just $x$</li>
                                <li>When you have <strong>$\\sqrt{expression}$</strong> where the expression is more than just $x$</li>
                            </ul>
                        </div>
                    `,
                    detailedExample: `
                        <div class="bg-blue-50/50 p-4 rounded-lg border border-blue-100 mb-4">
                            <h4 class="font-bold text-blue-900 mb-3">üîç Detailed example: $f(x) = (3x - 2)^4$</h4>

                            <div class="space-y-3 text-sm text-stone-700">
                                <div class="bg-white p-3 rounded border border-blue-100">
                                    <strong class="text-blue-700">Step 1: Identify outer and inner function</strong>
                                    <div class="mt-2 ml-4">
                                        <p>‚Ä¢ <strong>Outer function:</strong> $g(u) = u^4$</p>
                                        <p>‚Ä¢ <strong>Inner function:</strong> $u(x) = 3x - 2$</p>
                                    </div>
                                </div>

                                <div class="bg-white p-3 rounded border border-blue-100">
                                    <strong class="text-blue-700">Step 2: Differentiate outer (leave inner unchanged)</strong>
                                    <div class="mt-2 ml-4">
                                        <p>$g'(u) = 4u^3 = 4(3x-2)^3$</p>
                                    </div>
                                </div>

                                <div class="bg-white p-3 rounded border border-blue-100">
                                    <strong class="text-blue-700">Step 3: Differentiate inner</strong>
                                    <div class="mt-2 ml-4">
                                        <p>$u'(x) = 3$</p>
                                    </div>
                                </div>

                                <div class="bg-white p-3 rounded border border-blue-100">
                                    <strong class="text-blue-700">Step 4: Multiply (outer ¬∑ inner)</strong>
                                    <div class="mt-2 ml-4">
                                        <p>$$f'(x) = 4(3x-2)^3 \\cdot 3 = 12(3x-2)^3$$</p>
                                    </div>
                                </div>

                                <div class="bg-emerald-50 p-3 rounded border border-emerald-200 mt-3">
                                    <strong class="text-emerald-800">‚úÖ Answer:</strong> $f'(x) = 12(3x-2)^3$
                                </div>
                            </div>
                        </div>
                    `
                },
                es: {
                    title: "Regla de la Cadena",
                    intro: "La regla de la cadena se usa para derivar funciones compuestas - funciones dentro de funciones.",
                    formula: "$$f(x) = g(u(x)) \\implies f'(x) = g'(u) \\cdot u'(x)$$",
                    ruleText: "Deriv externa ¬∑ Deriv interna",
                    whenToUse: `
                        <div class="mb-4">
                            <h4 class="font-bold text-stone-700 mb-2">üìå ¬øCu√°ndo usar la regla de la cadena?</h4>
                            <ul class="list-disc list-inside space-y-1 text-stone-600">
                                <li>Cuando tienes una <strong>funci√≥n dentro de otra funci√≥n</strong></li>
                                <li>Cuando ves <strong>potencias de expresiones</strong> como $(2x+1)^3$</li>
                                <li>Cuando tienes <strong>$e^{expresi√≥n}$</strong> o <strong>$\\ln(expresi√≥n)$</strong></li>
                                <li>Cuando tienes <strong>$\\sqrt{expresi√≥n}$</strong></li>
                            </ul>
                        </div>
                    `,
                    detailedExample: `
                        <div class="bg-blue-50/50 p-4 rounded-lg border border-blue-100 mb-4">
                            <h4 class="font-bold text-blue-900 mb-3">üîç Ejemplo detallado: $f(x) = (3x - 2)^4$</h4>

                            <div class="space-y-3 text-sm text-stone-700">
                                <div class="bg-white p-3 rounded border border-blue-100">
                                    <strong class="text-blue-700">Paso 1: Identificar funci√≥n externa e interna</strong>
                                    <div class="mt-2 ml-4">
                                        <p>‚Ä¢ <strong>Funci√≥n externa:</strong> $g(u) = u^4$</p>
                                        <p>‚Ä¢ <strong>Funci√≥n interna:</strong> $u(x) = 3x - 2$</p>
                                    </div>
                                </div>

                                <div class="bg-white p-3 rounded border border-blue-100">
                                    <strong class="text-blue-700">Paso 2: Derivar externa (dejar interna sin cambios)</strong>
                                    <div class="mt-2 ml-4">
                                        <p>$g'(u) = 4u^3 = 4(3x-2)^3$</p>
                                    </div>
                                </div>

                                <div class="bg-white p-3 rounded border border-blue-100">
                                    <strong class="text-blue-700">Paso 3: Derivar interna</strong>
                                    <div class="mt-2 ml-4">
                                        <p>$u'(x) = 3$</p>
                                    </div>
                                </div>

                                <div class="bg-white p-3 rounded border border-blue-100">
                                    <strong class="text-blue-700">Paso 4: Multiplicar</strong>
                                    <div class="mt-2 ml-4">
                                        <p>$$f'(x) = 4(3x-2)^3 \\cdot 3 = 12(3x-2)^3$$</p>
                                    </div>
                                </div>

                                <div class="bg-emerald-50 p-3 rounded border border-emerald-200 mt-3">
                                    <strong class="text-emerald-800">‚úÖ Respuesta:</strong> $f'(x) = 12(3x-2)^3$
                                </div>
                            </div>
                        </div>
                    `
                },
                uk: {
                    title: "–ü—Ä–∞–≤–∏–ª–æ –ª–∞–Ω—Ü—é–≥–∞",
                    intro: "–ü—Ä–∞–≤–∏–ª–æ –ª–∞–Ω—Ü—é–≥–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –ø—Ä–∏ –¥–∏—Ñ–µ—Ä–µ–Ω—Ü—ñ—é–≤–∞–Ω–Ω—ñ —Å–∫–ª–∞–¥–µ–Ω–∏—Ö —Ñ—É–Ω–∫—Ü—ñ–π - —Ñ—É–Ω–∫—Ü—ñ–π –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ–π.",
                    formula: "$$f(x) = g(u(x)) \\implies f'(x) = g'(u) \\cdot u'(x)$$",
                    ruleText: "–ó–æ–≤–Ω—ñ—à–Ω—è –ø–æ—Ö—ñ–¥–Ω–∞ ¬∑ –í–Ω—É—Ç—Ä—ñ—à–Ω—è –ø–æ—Ö—ñ–¥–Ω–∞",
                    whenToUse: `
                        <div class="mb-4">
                            <h4 class="font-bold text-stone-700 mb-2">üìå –ö–æ–ª–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –ø—Ä–∞–≤–∏–ª–æ –ª–∞–Ω—Ü—é–≥–∞?</h4>
                            <ul class="list-disc list-inside space-y-1 text-stone-600">
                                <li>–ö–æ–ª–∏ —É –≤–∞—Å <strong>—Ñ—É–Ω–∫—Ü—ñ—è –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ —ñ–Ω—à–æ—ó —Ñ—É–Ω–∫—Ü—ñ—ó</strong></li>
                                <li>–ö–æ–ª–∏ –≤–∏ –±–∞—á–∏—Ç–µ <strong>—Å—Ç–µ–ø–µ–Ω—ñ –≤–∏—Ä–∞–∑—ñ–≤</strong> —è–∫ $(2x+1)^3$</li>
                                <li>–ö–æ–ª–∏ —É –≤–∞—Å <strong>$e^{–≤–∏—Ä–∞–∑}$</strong> –∞–±–æ <strong>$\\ln(–≤–∏—Ä–∞–∑)$</strong></li>
                                <li>–ö–æ–ª–∏ —É –≤–∞—Å <strong>$\\sqrt{–≤–∏—Ä–∞–∑}$</strong></li>
                            </ul>
                        </div>
                    `,
                    detailedExample: `
                        <div class="bg-blue-50/50 p-4 rounded-lg border border-blue-100 mb-4">
                            <h4 class="font-bold text-blue-900 mb-3">üîç –î–µ—Ç–∞–ª—å–Ω–∏–π –ø—Ä–∏–∫–ª–∞–¥: $f(x) = (3x - 2)^4$</h4>
                            <div class="space-y-3 text-sm text-stone-700">
                                <div class="bg-white p-3 rounded border border-blue-100">
                                    <strong class="text-blue-700">–ö—Ä–æ–∫ 1: –í–∏–∑–Ω–∞—á–∏—Ç–∏ –∑–æ–≤–Ω—ñ—à–Ω—é —ñ –≤–Ω—É—Ç—Ä—ñ—à–Ω—é —Ñ—É–Ω–∫—Ü—ñ—ó</strong>
                                    <div class="mt-2 ml-4">
                                        <p>‚Ä¢ <strong>–ó–æ–≤–Ω—ñ—à–Ω—è —Ñ—É–Ω–∫—Ü—ñ—è:</strong> $g(u) = u^4$</p>
                                        <p>‚Ä¢ <strong>–í–Ω—É—Ç—Ä—ñ—à–Ω—è —Ñ—É–Ω–∫—Ü—ñ—è:</strong> $u(x) = 3x - 2$</p>
                                    </div>
                                </div>
                                <div class="bg-white p-3 rounded border border-blue-100">
                                    <strong class="text-blue-700">–ö—Ä–æ–∫ 2: –ü–æ—Ö—ñ–¥–Ω–∞ –∑–æ–≤–Ω—ñ—à–Ω—å–æ—ó (–∑–∞–ª–∏—à–∏—Ç–∏ –≤–Ω—É—Ç—Ä—ñ—à–Ω—é –±–µ–∑ –∑–º—ñ–Ω)</strong>
                                    <div class="mt-2 ml-4">
                                        <p>$g'(u) = 4u^3 = 4(3x-2)^3$</p>
                                    </div>
                                </div>
                                <div class="bg-white p-3 rounded border border-blue-100">
                                    <strong class="text-blue-700">–ö—Ä–æ–∫ 3: –ü–æ—Ö—ñ–¥–Ω–∞ –≤–Ω—É—Ç—Ä—ñ—à–Ω—å–æ—ó</strong>
                                    <div class="mt-2 ml-4">
                                        <p>$u'(x) = 3$</p>
                                    </div>
                                </div>
                                <div class="bg-white p-3 rounded border border-blue-100">
                                    <strong class="text-blue-700">–ö—Ä–æ–∫ 4: –ü–æ–º–Ω–æ–∂–∏—Ç–∏</strong>
                                    <div class="mt-2 ml-4">
                                        <p>$$f'(x) = 4(3x-2)^3 \\cdot 3 = 12(3x-2)^3$$</p>
                                    </div>
                                </div>
                                <div class="bg-emerald-50 p-3 rounded border border-emerald-200 mt-3">
                                    <strong class="text-emerald-800">‚úÖ –í—ñ–¥–ø–æ–≤—ñ–¥—å:</strong> $f'(x) = 12(3x-2)^3$
                                </div>
                            </div>
                        </div>
                    `
                }
            },
            product: {
                no: {
                    title: "Produktregelen",
                    intro: "Produktregelen brukes n√•r vi skal derivere et produkt (ganging) av to funksjoner.",
                    formula: "$$(u \\cdot v)' = u'v + uv'$$",
                    ruleText: "u'v + uv'",
                    whenToUse: `
                        <div class="mb-4">
                            <h4 class="font-bold text-stone-700 mb-2">üìå N√•r bruker du produktregelen?</h4>
                            <ul class="list-disc list-inside space-y-1 text-stone-600">
                                <li>N√•r du har <strong>to funksjoner ganget sammen</strong>, for eksempel $x^2 \\cdot e^x$</li>
                                <li>N√•r begge delene <strong>inneholder $x$</strong> og varierer (ikke konstanter)</li>
                                <li>N√•r du har <strong>polynom ganget med eksponentialfunksjon</strong>: $x^3 \\cdot e^{2x}$</li>
                                <li>N√•r du har <strong>polynom ganget med logaritme</strong>: $x^2 \\cdot \\ln(x)$</li>
                                <li>N√•r du har <strong>trigonometriske funksjoner ganget med andre funksjoner</strong>: $x \\cdot \\sin(x)$</li>
                            </ul>
                            <div class="mt-3 p-3 bg-amber-50 border border-amber-200 rounded">
                                <p class="text-sm text-amber-900"><strong>üí° Tips:</strong> Hvis bare √©n faktor inneholder $x$, trenger du ikke produktregelen!
                                For eksempel: $(3x^2)' = 3 \\cdot 2x = 6x$ (konstanten 3 kan st√• utenfor).</p>
                            </div>
                        </div>
                    `,
                    detailedExample: `
                        <div class="bg-blue-50/50 p-4 rounded-lg border border-blue-100 mb-4">
                            <h4 class="font-bold text-blue-900 mb-3">üîç Detaljert eksempel: $f(x) = x^2 \\cdot e^{3x}$</h4>

                            <div class="space-y-3 text-sm text-stone-700">
                                <div class="bg-white p-3 rounded border border-blue-100">
                                    <strong class="text-blue-700">Steg 1: Identifiser de to funksjonene</strong>
                                    <div class="mt-2 ml-4">
                                        <p>‚Ä¢ $u = x^2$ (f√∏rste faktor)</p>
                                        <p>‚Ä¢ $v = e^{3x}$ (andre faktor)</p>
                                        <p class="text-xs text-stone-500 italic mt-2">Siden begge inneholder $x$, m√• vi bruke produktregelen!</p>
                                    </div>
                                </div>

                                <div class="bg-white p-3 rounded border border-blue-100">
                                    <strong class="text-blue-700">Steg 2: Deriver hver funksjon for seg</strong>
                                    <div class="mt-2 ml-4">
                                        <p>‚Ä¢ $u' = 2x$ (potensregelen)</p>
                                        <p>‚Ä¢ $v' = 3e^{3x}$ (kjerneregelen p√• $e^{3x}$)</p>
                                        <p class="text-xs text-stone-500 italic mt-2">Husk: $(e^{ax})' = a \\cdot e^{ax}$</p>
                                    </div>
                                </div>

                                <div class="bg-white p-3 rounded border border-blue-100">
                                    <strong class="text-blue-700">Steg 3: Bruk formelen $(u \\cdot v)' = u'v + uv'$</strong>
                                    <div class="mt-2 ml-4">
                                        <p>$$f'(x) = u'v + uv'$$</p>
                                        <p>$$f'(x) = (2x)(e^{3x}) + (x^2)(3e^{3x})$$</p>
                                        <p class="text-xs text-stone-500 italic mt-2">
                                            F√∏rste ledd: $u'$ ganget med $v$ (original)<br>
                                            Andre ledd: $u$ (original) ganget med $v'$
                                        </p>
                                    </div>
                                </div>

                                <div class="bg-white p-3 rounded border border-blue-100">
                                    <strong class="text-blue-700">Steg 4: Forenkle (faktoriser hvis mulig)</strong>
                                    <div class="mt-2 ml-4">
                                        <p>$$f'(x) = 2xe^{3x} + 3x^2e^{3x}$$</p>
                                        <p>$$f'(x) = e^{3x}(2x + 3x^2)$$</p>
                                        <p>$$f'(x) = xe^{3x}(2 + 3x)$$</p>
                                        <p class="text-xs text-stone-500 italic mt-2">Vi faktoriserer ut fellesfaktorer for et enklere svar</p>
                                    </div>
                                </div>

                                <div class="bg-emerald-50 p-3 rounded border border-emerald-200 mt-3">
                                    <strong class="text-emerald-800">‚úÖ Svar:</strong> $f'(x) = xe^{3x}(2 + 3x)$
                                </div>
                            </div>
                        </div>

                        <div class="bg-purple-50 p-4 rounded-lg border border-purple-100 mt-4">
                            <h5 class="font-bold text-purple-900 mb-2">‚ö†Ô∏è Vanlige feil √• unng√•:</h5>
                            <ul class="list-disc list-inside space-y-1 text-sm text-purple-800">
                                <li><strong>FEIL:</strong> $(x^2 \\cdot e^{3x})' = 2x \\cdot 3e^{3x}$ ‚ùå (Du kan ikke bare gange derivertene!)</li>
                                <li><strong>RIKTIG:</strong> Du m√• bruke formelen $u'v + uv'$ ‚úÖ</li>
                                <li>Husk √• derivere <strong>begge</strong> funksjoner</li>
                                <li>Glem ikke √• ta med den <strong>originale</strong> funksjonen i hvert ledd</li>
                            </ul>
                        </div>
                    `
                },
                en: {
                    title: "Product Rule",
                    intro: "The product rule is used when differentiating a product of two functions.",
                    formula: "$$(u \\cdot v)' = u'v + uv'$$",
                    ruleText: "u'v + uv'",
                    whenToUse: `
                        <div class="mb-4">
                            <h4 class="font-bold text-stone-700 mb-2">üìå When to use the product rule?</h4>
                            <ul class="list-disc list-inside space-y-1 text-stone-600">
                                <li>When you have <strong>two functions multiplied together</strong>, e.g., $x^2 \\cdot e^x$</li>
                                <li>When both parts <strong>contain $x$</strong> (not constants)</li>
                                <li>When you have <strong>polynomial times exponential</strong>: $x^3 \\cdot e^{2x}$</li>
                                <li>When you have <strong>polynomial times logarithm</strong>: $x^2 \\cdot \\ln(x)$</li>
                            </ul>
                        </div>
                    `,
                    detailedExample: `
                        <div class="bg-blue-50/50 p-4 rounded-lg border border-blue-100 mb-4">
                            <h4 class="font-bold text-blue-900 mb-3">üîç Detailed example: $f(x) = x^2 \\cdot e^{3x}$</h4>

                            <div class="space-y-3 text-sm text-stone-700">
                                <div class="bg-white p-3 rounded border border-blue-100">
                                    <strong class="text-blue-700">Step 1: Identify the two functions</strong>
                                    <div class="mt-2 ml-4">
                                        <p>‚Ä¢ $u = x^2$</p>
                                        <p>‚Ä¢ $v = e^{3x}$</p>
                                    </div>
                                </div>

                                <div class="bg-white p-3 rounded border border-blue-100">
                                    <strong class="text-blue-700">Step 2: Differentiate each function</strong>
                                    <div class="mt-2 ml-4">
                                        <p>‚Ä¢ $u' = 2x$</p>
                                        <p>‚Ä¢ $v' = 3e^{3x}$</p>
                                    </div>
                                </div>

                                <div class="bg-white p-3 rounded border border-blue-100">
                                    <strong class="text-blue-700">Step 3: Apply formula $(u \\cdot v)' = u'v + uv'$</strong>
                                    <div class="mt-2 ml-4">
                                        <p>$$f'(x) = (2x)(e^{3x}) + (x^2)(3e^{3x})$$</p>
                                    </div>
                                </div>

                                <div class="bg-white p-3 rounded border border-blue-100">
                                    <strong class="text-blue-700">Step 4: Simplify</strong>
                                    <div class="mt-2 ml-4">
                                        <p>$$f'(x) = xe^{3x}(2 + 3x)$$</p>
                                    </div>
                                </div>

                                <div class="bg-emerald-50 p-3 rounded border border-emerald-200 mt-3">
                                    <strong class="text-emerald-800">‚úÖ Answer:</strong> $f'(x) = xe^{3x}(2 + 3x)$
                                </div>
                            </div>
                        </div>
                    `
                },
                es: {
                    title: "Regla del Producto",
                    intro: "La regla del producto se usa para derivar el producto de dos funciones.",
                    formula: "$$(u \\cdot v)' = u'v + uv'$$",
                    ruleText: "u'v + uv'",
                    whenToUse: `
                        <div class="mb-4">
                            <h4 class="font-bold text-stone-700 mb-2">üìå ¬øCu√°ndo usar la regla del producto?</h4>
                            <ul class="list-disc list-inside space-y-1 text-stone-600">
                                <li>Cuando tienes <strong>dos funciones multiplicadas</strong>, ej. $x^2 \\cdot e^x$</li>
                                <li>Cuando ambas partes <strong>contienen $x$</strong></li>
                                <li>Cuando tienes <strong>polinomio por exponencial</strong>: $x^3 \\cdot e^{2x}$</li>
                            </ul>
                        </div>
                    `,
                    detailedExample: `
                        <div class="bg-blue-50/50 p-4 rounded-lg border border-blue-100 mb-4">
                            <h4 class="font-bold text-blue-900 mb-3">üîç Ejemplo: $f(x) = x^2 \\cdot e^{3x}$</h4>
                            <div class="space-y-3 text-sm text-stone-700">
                                <div class="bg-emerald-50 p-3 rounded border border-emerald-200">
                                    <strong class="text-emerald-800">‚úÖ Respuesta:</strong> $f'(x) = xe^{3x}(2 + 3x)$
                                </div>
                            </div>
                        </div>
                    `
                },
                uk: {
                    title: "–ü—Ä–∞–≤–∏–ª–æ –¥–æ–±—É—Ç–∫—É",
                    intro: "–ü—Ä–∞–≤–∏–ª–æ –¥–æ–±—É—Ç–∫—É –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –ø—Ä–∏ –¥–∏—Ñ–µ—Ä–µ–Ω—Ü—ñ—é–≤–∞–Ω–Ω—ñ –¥–æ–±—É—Ç–∫—É –¥–≤–æ—Ö —Ñ—É–Ω–∫—Ü—ñ–π.",
                    formula: "$$(u \\cdot v)' = u'v + uv'$$",
                    ruleText: "u'v + uv'",
                    whenToUse: `
                        <div class="mb-4">
                            <h4 class="font-bold text-stone-700 mb-2">üìå –ö–æ–ª–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –ø—Ä–∞–≤–∏–ª–æ –¥–æ–±—É—Ç–∫—É?</h4>
                            <ul class="list-disc list-inside space-y-1 text-stone-600">
                                <li>–ö–æ–ª–∏ —É –≤–∞—Å <strong>–¥–≤—ñ —Ñ—É–Ω–∫—Ü—ñ—ó –ø–æ–º–Ω–æ–∂–µ–Ω—ñ —Ä–∞–∑–æ–º</strong>, –Ω–∞–ø—Ä. $x^2 \\cdot e^x$</li>
                                <li>–ö–æ–ª–∏ –æ–±–∏–¥–≤—ñ —á–∞—Å—Ç–∏–Ω–∏ <strong>–º—ñ—Å—Ç—è—Ç—å $x$</strong></li>
                                <li>–ö–æ–ª–∏ —É –≤–∞—Å <strong>–ø–æ–ª—ñ–Ω–æ–º –ø–æ–º–Ω–æ–∂–µ–Ω–∏–π –Ω–∞ –µ–∫—Å–ø–æ–Ω–µ–Ω—Ç—É</strong>: $x^3 \\cdot e^{2x}$</li>
                            </ul>
                        </div>
                    `,
                    detailedExample: `
                        <div class="bg-blue-50/50 p-4 rounded-lg border border-blue-100 mb-4">
                            <h4 class="font-bold text-blue-900 mb-3">üîç –ü—Ä–∏–∫–ª–∞–¥: $f(x) = x^2 \\cdot e^{3x}$</h4>
                            <div class="space-y-3 text-sm text-stone-700">
                                <div class="bg-white p-3 rounded border border-blue-100">
                                    <strong class="text-blue-700">–ö—Ä–æ–∫ 1: –í–∏–∑–Ω–∞—á–∏—Ç–∏ –¥–≤—ñ —Ñ—É–Ω–∫—Ü—ñ—ó</strong>
                                    <div class="mt-2 ml-4">
                                        <p>‚Ä¢ $u = x^2$</p>
                                        <p>‚Ä¢ $v = e^{3x}$</p>
                                    </div>
                                </div>
                                <div class="bg-white p-3 rounded border border-blue-100">
                                    <strong class="text-blue-700">–ö—Ä–æ–∫ 2: –ó–Ω–∞–π—Ç–∏ –ø–æ—Ö—ñ–¥–Ω—ñ</strong>
                                    <div class="mt-2 ml-4">
                                        <p>‚Ä¢ $u' = 2x$</p>
                                        <p>‚Ä¢ $v' = 3e^{3x}$</p>
                                    </div>
                                </div>
                                <div class="bg-white p-3 rounded border border-blue-100">
                                    <strong class="text-blue-700">–ö—Ä–æ–∫ 3: –ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ —Ñ–æ—Ä–º—É–ª—É</strong>
                                    <div class="mt-2 ml-4">
                                        <p>$$f'(x) = (2x)(e^{3x}) + (x^2)(3e^{3x})$$</p>
                                    </div>
                                </div>
                                <div class="bg-white p-3 rounded border border-blue-100">
                                    <strong class="text-blue-700">–ö—Ä–æ–∫ 4: –°–ø—Ä–æ—Å—Ç–∏—Ç–∏</strong>
                                    <div class="mt-2 ml-4">
                                        <p>$$f'(x) = xe^{3x}(2 + 3x)$$</p>
                                    </div>
                                </div>
                                <div class="bg-emerald-50 p-3 rounded border border-emerald-200">
                                    <strong class="text-emerald-800">‚úÖ –í—ñ–¥–ø–æ–≤—ñ–¥—å:</strong> $f'(x) = xe^{3x}(2 + 3x)$
                                </div>
                            </div>
                        </div>
                    `
                }
            },
            quotient: {
                no: {
                    title: "Br√∏kregelen",
                    intro: "Br√∏kregelen brukes n√•r vi skal derivere en br√∏k hvor b√•de teller og nevner inneholder $x$.",
                    formula: "$$\\left(\\frac{u}{v}\\right)' = \\frac{u'v - uv'}{v^2}$$",
                    ruleText: "(u'v - uv') / v¬≤",
                    whenToUse: `
                        <div class="mb-4">
                            <h4 class="font-bold text-stone-700 mb-2">üìå N√•r bruker du br√∏kregelen?</h4>
                            <ul class="list-disc list-inside space-y-1 text-stone-600">
                                <li>N√•r du har en <strong>br√∏k</strong> hvor b√•de teller og nevner inneholder $x$</li>
                                <li>N√•r du har <strong>rasjonale funksjoner</strong> som $\\frac{x^2 + 1}{x - 3}$</li>
                                <li>N√•r du har <strong>$\\frac{e^x}{x}$</strong> eller <strong>$\\frac{\\ln(x)}{x^2}$</strong></li>
                            </ul>
                            <div class="mt-3 p-3 bg-amber-50 border border-amber-200 rounded">
                                <p class="text-sm text-amber-900"><strong>üí° Tips:</strong> Hvis bare telleren inneholder $x$, kan du ofte bruke enklere regler:
                                <br>‚Ä¢ $\\frac{x^2}{3} = \\frac{1}{3}x^2$ ‚Üí bruk potensregelen
                                <br>‚Ä¢ Men $\\frac{x^2}{x+1}$ ‚Üí bruk br√∏kregelen (begge har $x$)
                                </p>
                            </div>
                            <div class="mt-3 p-3 bg-purple-50 border border-purple-200 rounded">
                                <p class="text-sm text-purple-900"><strong>üéØ Huskeregel:</strong> "lo-d-hi minus hi-d-lo over lo-lo"
                                <br>‚Ä¢ <strong>lo</strong> (low) = nevner
                                <br>‚Ä¢ <strong>hi</strong> (high) = teller
                                <br>‚Ä¢ <strong>d</strong> = derivert
                                <br>Alts√•: (nevner ¬∑ teller') - (teller ¬∑ nevner') delt p√• nevner¬≤
                                </p>
                            </div>
                        </div>
                    `,
                    detailedExample: `
                        <div class="bg-blue-50/50 p-4 rounded-lg border border-blue-100 mb-4">
                            <h4 class="font-bold text-blue-900 mb-3">üîç Detaljert eksempel: $f(x) = \\frac{x^2 + 1}{2x - 3}$</h4>

                            <div class="space-y-3 text-sm text-stone-700">
                                <div class="bg-white p-3 rounded border border-blue-100">
                                    <strong class="text-blue-700">Steg 1: Identifiser teller og nevner</strong>
                                    <div class="mt-2 ml-4">
                                        <p>‚Ä¢ $u = x^2 + 1$ (teller)</p>
                                        <p>‚Ä¢ $v = 2x - 3$ (nevner)</p>
                                        <p class="text-xs text-stone-500 italic mt-2">Siden begge inneholder $x$, m√• vi bruke br√∏kregelen!</p>
                                    </div>
                                </div>

                                <div class="bg-white p-3 rounded border border-blue-100">
                                    <strong class="text-blue-700">Steg 2: Deriver teller og nevner hver for seg</strong>
                                    <div class="mt-2 ml-4">
                                        <p>‚Ä¢ $u' = 2x$ (deriverer $x^2 + 1$ ledd for ledd)</p>
                                        <p>‚Ä¢ $v' = 2$ (deriverer $2x - 3$)</p>
                                    </div>
                                </div>

                                <div class="bg-white p-3 rounded border border-blue-100">
                                    <strong class="text-blue-700">Steg 3: Bruk formelen $\\left(\\frac{u}{v}\\right)' = \\frac{u'v - uv'}{v^2}$</strong>
                                    <div class="mt-2 ml-4">
                                        <p>$$f'(x) = \\frac{u'v - uv'}{v^2}$$</p>
                                        <p class="mt-2">Setter inn:</p>
                                        <p>$$f'(x) = \\frac{(2x)(2x-3) - (x^2+1)(2)}{(2x-3)^2}$$</p>
                                        <p class="text-xs text-stone-500 italic mt-2">
                                            Teller: (derivert teller ¬∑ original nevner) - (original teller ¬∑ derivert nevner)<br>
                                            Nevner: (original nevner)¬≤
                                        </p>
                                    </div>
                                </div>

                                <div class="bg-white p-3 rounded border border-blue-100">
                                    <strong class="text-blue-700">Steg 4: Forenkle telleren</strong>
                                    <div class="mt-2 ml-4">
                                        <p class="mb-2">Gang ut i telleren:</p>
                                        <p>$2x(2x-3) = 4x^2 - 6x$</p>
                                        <p>$(x^2+1)(2) = 2x^2 + 2$</p>
                                        <p class="mt-2">Trekk fra:</p>
                                        <p>$(4x^2 - 6x) - (2x^2 + 2)$</p>
                                        <p>$= 4x^2 - 6x - 2x^2 - 2$</p>
                                        <p>$= 2x^2 - 6x - 2$</p>
                                    </div>
                                </div>

                                <div class="bg-white p-3 rounded border border-blue-100">
                                    <strong class="text-blue-700">Steg 5: Skriv ferdig svar</strong>
                                    <div class="mt-2 ml-4">
                                        <p>$$f'(x) = \\frac{2x^2 - 6x - 2}{(2x-3)^2}$$</p>
                                        <p class="text-xs text-stone-500 italic mt-2">Vi kan ogs√• faktorisere teller hvis √∏nskelig: $\\frac{2(x^2 - 3x - 1)}{(2x-3)^2}$</p>
                                    </div>
                                </div>

                                <div class="bg-emerald-50 p-3 rounded border border-emerald-200 mt-3">
                                    <strong class="text-emerald-800">‚úÖ Svar:</strong> $f'(x) = \\frac{2x^2 - 6x - 2}{(2x-3)^2}$
                                </div>
                            </div>
                        </div>

                        <div class="bg-purple-50 p-4 rounded-lg border border-purple-100 mt-4">
                            <h5 class="font-bold text-purple-900 mb-2">‚ö†Ô∏è Vanlige feil √• unng√•:</h5>
                            <ul class="list-disc list-inside space-y-1 text-sm text-purple-800">
                                <li><strong>FEIL:</strong> $\\left(\\frac{u}{v}\\right)' = \\frac{u'}{v'}$ ‚ùå (Du kan ikke bare derivere teller og nevner hver for seg!)</li>
                                <li><strong>FEIL:</strong> Glemme minustegnet: Det er $u'v - uv'$ (ikke pluss!)</li>
                                <li><strong>FEIL:</strong> Glemme √• kvadrere nevneren: Det er $v^2$ ikke bare $v$</li>
                                <li><strong>RIKTIG:</strong> Bruk formelen n√∏yaktig: $\\frac{u'v - uv'}{v^2}$ ‚úÖ</li>
                                <li>V√¶r <strong>ekstra n√∏ye</strong> med parenteser n√•r du regner ut $(uv')$</li>
                            </ul>
                        </div>

                        <div class="bg-blue-50 p-4 rounded-lg border border-blue-100 mt-4">
                            <h5 class="font-bold text-blue-900 mb-2">üí° Alternativ: N√•r kan du unng√• br√∏kregelen?</h5>
                            <p class="text-sm text-blue-800 mb-2">Noen ganger kan du omskrive br√∏ken for √• slippe br√∏kregelen:</p>
                            <ul class="list-disc list-inside space-y-1 text-sm text-blue-800">
                                <li>$\\frac{1}{x^2} = x^{-2}$ ‚Üí bruk potensregelen: $(x^{-2})' = -2x^{-3}$</li>
                                <li>$\\frac{x^3}{x} = x^2$ ‚Üí forenkle f√∏rst, s√• deriver: $(x^2)' = 2x$</li>
                                <li>$\\frac{\\sqrt{x}}{x} = \\frac{x^{1/2}}{x} = x^{-1/2}$ ‚Üí bruk potensregelen</li>
                            </ul>
                        </div>
                    `
                },
                en: {
                    title: "Quotient Rule",
                    intro: "The quotient rule is used when differentiating a fraction where both numerator and denominator contain $x$.",
                    formula: "$$\\left(\\frac{u}{v}\\right)' = \\frac{u'v - uv'}{v^2}$$",
                    ruleText: "(u'v - uv') / v¬≤",
                    whenToUse: `
                        <div class="mb-4">
                            <h4 class="font-bold text-stone-700 mb-2">üìå When to use the quotient rule?</h4>
                            <ul class="list-disc list-inside space-y-1 text-stone-600">
                                <li>When you have a <strong>fraction</strong> where both numerator and denominator contain $x$</li>
                                <li>When you have <strong>rational functions</strong> like $\\frac{x^2 + 1}{x - 3}$</li>
                                <li>When you have <strong>$\\frac{e^x}{x}$</strong> or <strong>$\\frac{\\ln(x)}{x^2}$</strong></li>
                            </ul>
                            <div class="mt-3 p-3 bg-purple-50 border border-purple-200 rounded">
                                <p class="text-sm text-purple-900"><strong>üéØ Memory aid:</strong> "lo-d-hi minus hi-d-lo over lo-lo"
                                <br>‚Ä¢ <strong>lo</strong> = denominator (bottom)
                                <br>‚Ä¢ <strong>hi</strong> = numerator (top)
                                <br>‚Ä¢ <strong>d</strong> = derivative
                                </p>
                            </div>
                        </div>
                    `,
                    detailedExample: `
                        <div class="bg-blue-50/50 p-4 rounded-lg border border-blue-100 mb-4">
                            <h4 class="font-bold text-blue-900 mb-3">üîç Detailed example: $f(x) = \\frac{x^2 + 1}{2x - 3}$</h4>

                            <div class="space-y-3 text-sm text-stone-700">
                                <div class="bg-white p-3 rounded border border-blue-100">
                                    <strong class="text-blue-700">Step 1: Identify numerator and denominator</strong>
                                    <div class="mt-2 ml-4">
                                        <p>‚Ä¢ $u = x^2 + 1$ (numerator)</p>
                                        <p>‚Ä¢ $v = 2x - 3$ (denominator)</p>
                                    </div>
                                </div>

                                <div class="bg-white p-3 rounded border border-blue-100">
                                    <strong class="text-blue-700">Step 2: Differentiate each</strong>
                                    <div class="mt-2 ml-4">
                                        <p>‚Ä¢ $u' = 2x$</p>
                                        <p>‚Ä¢ $v' = 2$</p>
                                    </div>
                                </div>

                                <div class="bg-white p-3 rounded border border-blue-100">
                                    <strong class="text-blue-700">Step 3: Apply formula</strong>
                                    <div class="mt-2 ml-4">
                                        <p>$$f'(x) = \\frac{(2x)(2x-3) - (x^2+1)(2)}{(2x-3)^2}$$</p>
                                    </div>
                                </div>

                                <div class="bg-white p-3 rounded border border-blue-100">
                                    <strong class="text-blue-700">Step 4: Simplify</strong>
                                    <div class="mt-2 ml-4">
                                        <p>$$f'(x) = \\frac{2x^2 - 6x - 2}{(2x-3)^2}$$</p>
                                    </div>
                                </div>

                                <div class="bg-emerald-50 p-3 rounded border border-emerald-200 mt-3">
                                    <strong class="text-emerald-800">‚úÖ Answer:</strong> $f'(x) = \\frac{2x^2 - 6x - 2}{(2x-3)^2}$
                                </div>
                            </div>
                        </div>
                    `
                },
                es: {
                    title: "Regla del Cociente",
                    intro: "La regla del cociente se usa para derivar una fracci√≥n donde numerador y denominador contienen $x$.",
                    formula: "$$\\left(\\frac{u}{v}\\right)' = \\frac{u'v - uv'}{v^2}$$",
                    ruleText: "(u'v - uv') / v¬≤",
                    whenToUse: `
                        <div class="mb-4">
                            <h4 class="font-bold text-stone-700 mb-2">üìå ¬øCu√°ndo usar?</h4>
                            <ul class="list-disc list-inside space-y-1 text-stone-600">
                                <li>Cuando tienes una <strong>fracci√≥n</strong> con $x$ en numerador y denominador</li>
                            </ul>
                        </div>
                    `,
                    detailedExample: `
                        <div class="bg-blue-50/50 p-4 rounded-lg border border-blue-100 mb-4">
                            <h4 class="font-bold text-blue-900 mb-3">üîç Ejemplo: $f(x) = \\frac{x^2 + 1}{2x - 3}$</h4>
                            <div class="bg-emerald-50 p-3 rounded border border-emerald-200">
                                <strong class="text-emerald-800">‚úÖ Respuesta:</strong> $f'(x) = \\frac{2x^2 - 6x - 2}{(2x-3)^2}$
                            </div>
                        </div>
                    `
                },
                uk: {
                    title: "–ü—Ä–∞–≤–∏–ª–æ —á–∞—Å—Ç–∫–∏",
                    intro: "–ü—Ä–∞–≤–∏–ª–æ —á–∞—Å—Ç–∫–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –ø—Ä–∏ –¥–∏—Ñ–µ—Ä–µ–Ω—Ü—ñ—é–≤–∞–Ω–Ω—ñ –¥—Ä–æ–±—É, –¥–µ —á–∏—Å–µ–ª—å–Ω–∏–∫ —ñ –∑–Ω–∞–º–µ–Ω–Ω–∏–∫ –º—ñ—Å—Ç—è—Ç—å $x$.",
                    formula: "$$\\left(\\frac{u}{v}\\right)' = \\frac{u'v - uv'}{v^2}$$",
                    ruleText: "(u'v - uv') / v¬≤",
                    whenToUse: `
                        <div class="mb-4">
                            <h4 class="font-bold text-stone-700 mb-2">üìå –ö–æ–ª–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –ø—Ä–∞–≤–∏–ª–æ —á–∞—Å—Ç–∫–∏?</h4>
                            <ul class="list-disc list-inside space-y-1 text-stone-600">
                                <li>–ö–æ–ª–∏ —É –≤–∞—Å <strong>–¥—Ä—ñ–±</strong> –¥–µ —á–∏—Å–µ–ª—å–Ω–∏–∫ —ñ –∑–Ω–∞–º–µ–Ω–Ω–∏–∫ –º—ñ—Å—Ç—è—Ç—å $x$</li>
                                <li>–ö–æ–ª–∏ —É –≤–∞—Å <strong>—Ä–∞—Ü—ñ–æ–Ω–∞–ª—å–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó</strong> —è–∫ $\\frac{x^2 + 1}{x - 3}$</li>
                                <li>–ö–æ–ª–∏ —É –≤–∞—Å <strong>$\\frac{e^x}{x}$</strong> –∞–±–æ <strong>$\\frac{\\ln(x)}{x^2}$</strong></li>
                            </ul>
                            <div class="mt-3 p-3 bg-purple-50 border border-purple-200 rounded">
                                <p class="text-sm text-purple-900"><strong>üéØ –ü—ñ–¥–∫–∞–∑–∫–∞:</strong> "–∑–Ω–∞–º–µ–Ω–Ω–∏–∫-–ø–æ—Ö—ñ–¥–Ω–∞-—á–∏—Å–µ–ª—å–Ω–∏–∫ –º—ñ–Ω—É—Å —á–∏—Å–µ–ª—å–Ω–∏–∫-–ø–æ—Ö—ñ–¥–Ω–∞-–∑–Ω–∞–º–µ–Ω–Ω–∏–∫, –≤—Å–µ –ø–æ–¥—ñ–ª–µ–Ω–µ –Ω–∞ –∑–Ω–∞–º–µ–Ω–Ω–∏–∫-–∫–≤–∞–¥—Ä–∞—Ç"</p>
                            </div>
                        </div>
                    `,
                    detailedExample: `
                        <div class="bg-blue-50/50 p-4 rounded-lg border border-blue-100 mb-4">
                            <h4 class="font-bold text-blue-900 mb-3">üîç –ü—Ä–∏–∫–ª–∞–¥: $f(x) = \\frac{x^2 + 1}{2x - 3}$</h4>
                            <div class="space-y-3 text-sm text-stone-700">
                                <div class="bg-white p-3 rounded border border-blue-100">
                                    <strong class="text-blue-700">–ö—Ä–æ–∫ 1: –í–∏–∑–Ω–∞—á–∏—Ç–∏ —á–∏—Å–µ–ª—å–Ω–∏–∫ —ñ –∑–Ω–∞–º–µ–Ω–Ω–∏–∫</strong>
                                    <div class="mt-2 ml-4">
                                        <p>‚Ä¢ $u = x^2 + 1$ (—á–∏—Å–µ–ª—å–Ω–∏–∫)</p>
                                        <p>‚Ä¢ $v = 2x - 3$ (–∑–Ω–∞–º–µ–Ω–Ω–∏–∫)</p>
                                    </div>
                                </div>
                                <div class="bg-white p-3 rounded border border-blue-100">
                                    <strong class="text-blue-700">–ö—Ä–æ–∫ 2: –ó–Ω–∞–π—Ç–∏ –ø–æ—Ö—ñ–¥–Ω—ñ</strong>
                                    <div class="mt-2 ml-4">
                                        <p>‚Ä¢ $u' = 2x$</p>
                                        <p>‚Ä¢ $v' = 2$</p>
                                    </div>
                                </div>
                                <div class="bg-white p-3 rounded border border-blue-100">
                                    <strong class="text-blue-700">–ö—Ä–æ–∫ 3: –ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ —Ñ–æ—Ä–º—É–ª—É</strong>
                                    <div class="mt-2 ml-4">
                                        <p>$$f'(x) = \\frac{(2x)(2x-3) - (x^2+1)(2)}{(2x-3)^2}$$</p>
                                    </div>
                                </div>
                                <div class="bg-white p-3 rounded border border-blue-100">
                                    <strong class="text-blue-700">–ö—Ä–æ–∫ 4: –°–ø—Ä–æ—Å—Ç–∏—Ç–∏</strong>
                                    <div class="mt-2 ml-4">
                                        <p>$$f'(x) = \\frac{2x^2 - 6x - 2}{(2x-3)^2}$$</p>
                                    </div>
                                </div>
                                <div class="bg-emerald-50 p-3 rounded border border-emerald-200">
                                    <strong class="text-emerald-800">‚úÖ –í—ñ–¥–ø–æ–≤—ñ–¥—å:</strong> $f'(x) = \\frac{2x^2 - 6x - 2}{(2x-3)^2}$
                                </div>
                            </div>
                        </div>
                    `
                }
            }
        };

        // --- PROBLEM GENERATOR ---
        let problemBank = [];

        function fmt(coeff, varName, isFirst = true) {
            if (coeff === 0) return "";
            let str = "";
            if (!isFirst && coeff > 0) str += "+";
            if (coeff === 1) str += varName;
            else if (coeff === -1) str += "-" + varName;
            else str += coeff + varName;
            return str;
        }
        function fmtNum(num, isFirst = false) {
            if (num === 0) return "";
            if (num > 0 && !isFirst) return "+" + num;
            return "" + num;
        }
        function fmtPow(n) {
            return n === 1 ? "" : `^${n}`;
        }

        function generateProblemBank() {
            let id = 1000;
            const types = ['poly', 'root', 'exp', 'log'];
            const rules = ['chain', 'product', 'quotient'];
            const levels = [1, 2, 3, 4, 5];
            
            const bank = [];

            const add = (topic, level, type, q, a, steps, hint) => {
                bank.push({ id: id++, topic, level, type, q, a, steps, hint });
            };

            rules.forEach(rule => {
                levels.forEach(lvl => {
                    types.forEach(type => {
                        for(let i=0; i<20; i++) {
                            generateSingleProblem(rule, lvl, type, add);
                        }
                    });
                });
            });
            
            return bank;
        }

        function generateProductProblem(type, lvl, a, b, n, add) {
            const r = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
            const par = (val) => val < 0 ? `(${val})` : val;

            // Helper to create aligned environment steps
            const makeAlignedSteps = (u, v, up, vp, steps) => {
                return `$$
\\begin{aligned}
u &= ${u} & v &= ${v} \\\\
u' &= ${up} & v' &= ${vp}
\\end{aligned}
$$
$$
\\begin{aligned}
${steps}
\\end{aligned}
$$`;
            };

            if (type === 'poly') {
                generateProductPoly(lvl, a, b, n, add, makeAlignedSteps, par, r);
            }
            else if (type === 'root') {
                generateProductRoot(lvl, a, b, n, add, makeAlignedSteps, par, r);
            }
            else if (type === 'exp') {
                generateProductExp(lvl, a, b, n, add, makeAlignedSteps, par, r);
            }
            else if (type === 'log') {
                generateProductLog(lvl, a, b, n, add, makeAlignedSteps, par, r);
            }
        }

        function generateProductPoly(lvl, a, b, n, add, makeAlignedSteps, par, r) {
            const patterns = [];

            // Level 1: Easy basics
            if (lvl === 1) {
                patterns.push(() => {
                    // x ¬∑ (x + a) - simple linear times linear
                    const v = `x ${fmtNum(a)}`;
                    const raw = `1 \\cdot (${v}) + x \\cdot 1`;
                    const simp = `2x ${fmtNum(a)}`;
                    const ans = `f'(x) = ${simp}`;
                    const steps = `f'(x) &= u'v + uv' \\\\
&= ${raw} \\\\
&= ${simp}`;
                    return {
                        q: `f(x) = x(${v})`,
                        a: `$$ ${ans} $$`,
                        steps: makeAlignedSteps(`x`, v, `1`, `1`, steps),
                        hint: "To line√¶re faktorer - enkel produktregel."
                    };
                });

                patterns.push(() => {
                    // (x + a)(x + b) - binomial product
                    const c = r(1, 3) * (Math.random() > 0.5 ? 1 : -1);
                    const u = `x ${fmtNum(a)}`;
                    const v = `x ${fmtNum(c)}`;
                    const raw = `1 \\cdot (${v}) + (${u}) \\cdot 1`;
                    const simp = `2x ${fmtNum(a + c)}`;
                    const ans = `f'(x) = ${simp}`;
                    const steps = `f'(x) &= u'v + uv' \\\\
&= ${raw} \\\\
&= ${simp}`;
                    return {
                        q: `f(x) = (${u})(${v})`,
                        a: `$$ ${ans} $$`,
                        steps: makeAlignedSteps(u, v, `1`, `1`, steps),
                        hint: "Produktet av to binomer."
                    };
                });
            }

            // Level 2: Quadratic terms
            else if (lvl === 2) {
                patterns.push(() => {
                    // x¬≤ ¬∑ (ax + b) - quadratic times linear
                    const v = `${fmt(a,'x')} ${fmtNum(b)}`;
                    const raw = `2x(${v}) + x^2 \\cdot ${a}`;
                    const expanded = `${2*a}x^2 ${fmtNum(2*b, true)}x + ${a}x^2`;
                    const simp = `${3*a}x^2 ${fmtNum(2*b, true)}x`;
                    const factored = `x(${3*a}x ${fmtNum(2*b)})`;
                    const ans = `f'(x) = ${factored}`;
                    const steps = `f'(x) &= u'v + uv' \\\\
&= ${raw} \\\\
&= ${simp} \\\\
&= ${factored}`;
                    return {
                        q: `f(x) = x^2(${v})`,
                        a: `$$ ${ans} $$`,
                        steps: makeAlignedSteps(`x^2`, v, `2x`, `${a}`, steps),
                        hint: "Kvadratisk ganger line√¶r - faktoriser resultatet."
                    };
                });

                patterns.push(() => {
                    // x ¬∑ (x¬≤ + a) - linear times quadratic
                    const v = `x^2 ${fmtNum(a)}`;
                    const raw = `1 \\cdot (${v}) + x \\cdot 2x`;
                    const simp = `3x^2 ${fmtNum(a)}`;
                    const ans = `f'(x) = ${simp}`;
                    const steps = `f'(x) &= u'v + uv' \\\\
&= ${raw} \\\\
&= ${simp}`;
                    return {
                        q: `f(x) = x(${v})`,
                        a: `$$ ${ans} $$`,
                        steps: makeAlignedSteps(`x`, v, `1`, `2x`, steps),
                        hint: "Line√¶r ganger kvadratisk."
                    };
                });
            }

            // Level 3: Chain rule integration
            else if (lvl === 3) {
                patterns.push(() => {
                    // x ¬∑ (ax + b)¬≤ - linear times squared binomial
                    const inner = `${fmt(a,'x')} ${fmtNum(b)}`;
                    const v = `(${inner})^2`;
                    const vp = `2(${inner}) \\cdot ${a}`;
                    const raw = `1 \\cdot ${v} + x \\cdot ${vp}`;
                    const ans = `f'(x) = ${v} + x \\cdot ${vp}`;
                    const steps = `f'(x) &= u'v + uv' \\\\
&= ${raw}`;
                    return {
                        q: `f(x) = x(${inner})^2`,
                        a: `$$ ${ans} $$`,
                        steps: makeAlignedSteps(`x`, v, `1`, vp, steps),
                        hint: "Bruk kjerneregelen p√• den kvadrerte faktoren."
                    };
                });

                patterns.push(() => {
                    // x¬≤ ¬∑ (x¬≤ + a) - quadratic times quadratic
                    const v = `x^2 ${fmtNum(a)}`;
                    const raw = `2x(${v}) + x^2 \\cdot 2x`;
                    const expanded = `2x^3 ${fmtNum(2*a, true)}x + 2x^3`;
                    const simp = `4x^3 ${fmtNum(2*a, true)}x`;
                    const factored = `2x(2x^2 ${fmtNum(a)})`;
                    const ans = `f'(x) = ${factored}`;
                    const steps = `f'(x) &= u'v + uv' \\\\
&= ${raw} \\\\
&= ${simp} \\\\
&= ${factored}`;
                    return {
                        q: `f(x) = x^2(${v})`,
                        a: `$$ ${ans} $$`,
                        steps: makeAlignedSteps(`x^2`, v, `2x`, `2x`, steps),
                        hint: "To kvadratiske faktorer."
                    };
                });
            }

            // Level 4: Advanced - complex polynomials
            else if (lvl === 4) {
                patterns.push(() => {
                    // (x¬≤ + a) ¬∑ (x¬≤ + b) - quadratic times quadratic
                    const c = r(1, 3) * (Math.random() > 0.5 ? 1 : -1);
                    const u = `x^2 ${fmtNum(a)}`;
                    const v = `x^2 ${fmtNum(c)}`;
                    const raw = `2x(${v}) + (${u}) \\cdot 2x`;
                    const expanded = `2x^3 ${fmtNum(2*c, true)}x + 2x^3 ${fmtNum(2*a, true)}x`;
                    const simp = `4x^3 ${fmtNum(2*(a + c), true)}x`;
                    const factored = `2x(2x^2 ${fmtNum(a + c)})`;
                    const ans = `f'(x) = ${factored}`;
                    const steps = `f'(x) &= u'v + uv' \\\\
&= ${raw} \\\\
&= ${simp} \\\\
&= ${factored}`;
                    return {
                        q: `f(x) = (${u})(${v})`,
                        a: `$$ ${ans} $$`,
                        steps: makeAlignedSteps(u, v, `2x`, `2x`, steps),
                        hint: "Produktet av to kvadratiske uttrykk."
                    };
                });

                patterns.push(() => {
                    // x¬≥ ¬∑ (x¬≤ + a) - cubic times quadratic
                    const v = `x^2 ${fmtNum(a)}`;
                    const raw = `3x^2(${v}) + x^3 \\cdot 2x`;
                    const expanded = `3x^4 ${fmtNum(3*a, true)}x^2 + 2x^4`;
                    const simp = `5x^4 ${fmtNum(3*a, true)}x^2`;
                    const factored = `x^2(5x^2 ${fmtNum(3*a)})`;
                    const ans = `f'(x) = ${factored}`;
                    const steps = `f'(x) &= u'v + uv' \\\\
&= ${raw} \\\\
&= ${simp} \\\\
&= ${factored}`;
                    return {
                        q: `f(x) = x^3(${v})`,
                        a: `$$ ${ans} $$`,
                        steps: makeAlignedSteps(`x^3`, v, `3x^2`, `2x`, steps),
                        hint: "Kubisk ganger kvadratisk - h√∏yere grads polynom."
                    };
                });
            }

            // Level 5: Expert - very challenging
            else {
                patterns.push(() => {
                    // (x¬≤ + a)¬≤ ¬∑ (x + b) - squared quadratic times linear
                    const c = r(1, 2);
                    const inner = `x^2 ${fmtNum(a)}`;
                    const u = `(${inner})^2`;
                    const up = `2(${inner}) \\cdot 2x`;
                    const v = `x ${fmtNum(c)}`;
                    const raw = `${up}(${v}) + ${u} \\cdot 1`;
                    const ans = `f'(x) = ${up}(${v}) + ${u}`;
                    const steps = `f'(x) &= u'v + uv' \\\\
&= ${raw}`;
                    return {
                        q: `f(x) = (${inner})^2(${v})`,
                        a: `$$ ${ans} $$`,
                        steps: makeAlignedSteps(u, v, up, `1`, steps),
                        hint: "Kvadrert kvadratisk uttrykk - dobbel kjerneregel."
                    };
                });

                patterns.push(() => {
                    // (x¬≤ + a) ¬∑ (x¬≤ + b) ¬∑ (x + c) - triple product!
                    const c = r(1, 2);
                    const d = r(1, 2) * (Math.random() > 0.5 ? 1 : -1);
                    const u1 = `x^2 ${fmtNum(a)}`;
                    const u2 = `x^2 ${fmtNum(c)}`;
                    const u3 = `x ${fmtNum(d)}`;
                    const ans = `f'(x) = 2x(${u2})(${u3}) + (${u1}) \\cdot 2x(${u3}) + (${u1})(${u2}) \\cdot 1`;
                    const steps = `f'(x) &= u'vw + uv'w + uvw' \\\\
&= ${ans}`;
                    return {
                        q: `f(x) = (${u1})(${u2})(${u3})`,
                        a: `$$ ${ans} $$`,
                        steps: `$$
\\begin{aligned}
u &= ${u1} & v &= ${u2} & w &= ${u3} \\\\
u' &= 2x & v' &= 2x & w' &= 1
\\end{aligned}
$$
$$
\\begin{aligned}
${steps}
\\end{aligned}
$$`,
                        hint: "Trippel-produkt! Bruk formelen: (uvw)' = u'vw + uv'w + uvw'"
                    };
                });
            }

            const pattern = patterns[r(0, patterns.length - 1)];
            const prob = pattern();
            add('product', lvl, 'poly', prob.q, prob.a, prob.steps, prob.hint);
        }

        function generateProductRoot(lvl, a, b, n, add, makeAlignedSteps, par, r) {
            const patterns = [];

            // Level 1: Easy basics
            if (lvl === 1) {
                patterns.push(() => {
                    // x ¬∑ ‚àöx - simple product
                    const raw = `1 \\cdot \\sqrt{x} + x \\cdot \\frac{1}{2\\sqrt{x}}`;
                    const combined = `\\frac{2\\sqrt{x} + x}{2\\sqrt{x}}`;
                    const simp = `\\frac{3x}{2\\sqrt{x}}`;
                    const final = `\\frac{3\\sqrt{x}}{2}`;
                    const ans = `f'(x) = ${final}`;
                    const steps = `f'(x) &= u'v + uv' \\\\
&= ${raw} \\\\
&= ${combined} \\\\
&= ${simp} \\\\
&= ${final}`;
                    return {
                        q: `f(x) = x\\sqrt{x}`,
                        a: `$$ ${ans} $$`,
                        steps: makeAlignedSteps(`x`, `\\sqrt{x}`, `1`, `\\frac{1}{2\\sqrt{x}}`, steps),
                        hint: "x ganger kvadratrot x - kan ogs√• skrives som x^{3/2}."
                    };
                });

                patterns.push(() => {
                    // (x + a) ¬∑ ‚àöx - linear times root
                    const u = `x ${fmtNum(a)}`;
                    const raw = `1 \\cdot \\sqrt{x} + (${u}) \\cdot \\frac{1}{2\\sqrt{x}}`;
                    const combined = `\\frac{2\\sqrt{x} \\cdot \\sqrt{x} + (${u})}{2\\sqrt{x}}`;
                    const simp = `\\frac{2x ${fmtNum(a)}}{2\\sqrt{x}}`;
                    const ans = `f'(x) = \\frac{2x ${fmtNum(a)}}{2\\sqrt{x}}`;
                    const steps = `f'(x) &= u'v + uv' \\\\
&= ${raw} \\\\
&= ${ans}`;
                    return {
                        q: `f(x) = (${u})\\sqrt{x}`,
                        a: `$$ ${ans} $$`,
                        steps: makeAlignedSteps(u, `\\sqrt{x}`, `1`, `\\frac{1}{2\\sqrt{x}}`, steps),
                        hint: "Line√¶rt uttrykk ganger kvadratrot."
                    };
                });
            }

            // Level 2: More complex
            else if (lvl === 2) {
                patterns.push(() => {
                    // x¬≤ ¬∑ ‚àöx - quadratic times root
                    const raw = `2x \\cdot \\sqrt{x} + x^2 \\cdot \\frac{1}{2\\sqrt{x}}`;
                    const combined = `\\frac{4x\\sqrt{x} + x^2}{2\\sqrt{x}}`;
                    const simp = `\\frac{4x^{3/2} + x^2}{2\\sqrt{x}}`;
                    const ans = `f'(x) = \\frac{5x^2}{2\\sqrt{x}}`;
                    const steps = `f'(x) &= u'v + uv' \\\\
&= ${raw} \\\\
&= ${combined}`;
                    return {
                        q: `f(x) = x^2\\sqrt{x}`,
                        a: `$$ ${ans} $$`,
                        steps: makeAlignedSteps(`x^2`, `\\sqrt{x}`, `2x`, `\\frac{1}{2\\sqrt{x}}`, steps),
                        hint: "x¬≤ ganger ‚àöx = x^{5/2}."
                    };
                });

                patterns.push(() => {
                    // x ¬∑ ‚àö(ax + b) - linear times root with chain
                    const inner = `${fmt(a,'x')} ${fmtNum(b)}`;
                    const v = `\\sqrt{${inner}}`;
                    const vp = `\\frac{${a}}{2\\sqrt{${inner}}}`;
                    const raw = `1 \\cdot ${v} + x \\cdot ${vp}`;
                    const ans = `f'(x) = ${raw}`;
                    const steps = `f'(x) &= u'v + uv' \\\\
&= ${raw}`;
                    return {
                        q: `f(x) = x\\sqrt{${inner}}`,
                        a: `$$ ${ans} $$`,
                        steps: makeAlignedSteps(`x`, v, `1`, vp, steps),
                        hint: "Kjerneregel p√• kvadratroten."
                    };
                });
            }

            // Level 3: Chain rules
            else if (lvl === 3) {
                patterns.push(() => {
                    // x ¬∑ ‚àö(ax + b) with more complex chain
                    const inner = `${fmt(a,'x')} ${fmtNum(b)}`;
                    const v = `\\sqrt{${inner}}`;
                    const vp = `\\frac{${a}}{2\\sqrt{${inner}}}`;
                    const raw = `1 \\cdot ${v} + x \\cdot ${vp}`;
                    const ans = `f'(x) = ${v} + \\frac{${a}x}{2\\sqrt{${inner}}}`;
                    const steps = `f'(x) &= u'v + uv' \\\\
&= ${raw} \\\\
&= ${ans}`;
                    return {
                        q: `f(x) = x\\sqrt{${inner}}`,
                        a: `$$ ${ans} $$`,
                        steps: makeAlignedSteps(`x`, v, `1`, vp, steps),
                        hint: "Kombiner produktregel og kjerneregel."
                    };
                });

                patterns.push(() => {
                    // (ax + b) ¬∑ ‚àö(cx + d) - both need chain rule
                    const c = r(1, 2);
                    const d = r(1, 3) * (Math.random() > 0.5 ? 1 : -1);
                    const u = `${fmt(a,'x')} ${fmtNum(b)}`;
                    const v = `\\sqrt{${fmt(c,'x')} ${fmtNum(d)}}`;
                    const vp = `\\frac{${c}}{2\\sqrt{${fmt(c,'x')} ${fmtNum(d)}}}`;
                    const raw = `${a} \\cdot ${v} + (${u}) \\cdot ${vp}`;
                    const ans = `f'(x) = ${raw}`;
                    const steps = `f'(x) &= u'v + uv' \\\\
&= ${raw}`;
                    return {
                        q: `f(x) = (${u})${v}`,
                        a: `$$ ${ans} $$`,
                        steps: makeAlignedSteps(u, v, `${a}`, vp, steps),
                        hint: "Begge faktorer krever kjerneregel."
                    };
                });
            }

            // Level 4: Advanced
            else if (lvl === 4) {
                patterns.push(() => {
                    // (x¬≤ + a) ¬∑ ‚àö(bx + c) - quadratic times root with chain
                    const c = r(1, 2);
                    const d = r(1, 3);
                    const u = `x^2 ${fmtNum(a)}`;
                    const v = `\\sqrt{${fmt(c,'x')} ${fmtNum(d)}}`;
                    const vp = `\\frac{${c}}{2\\sqrt{${fmt(c,'x')} ${fmtNum(d)}}}`;
                    const raw = `2x \\cdot ${v} + (${u}) \\cdot ${vp}`;
                    const ans = `f'(x) = ${raw}`;
                    const steps = `f'(x) &= u'v + uv' \\\\
&= ${raw}`;
                    return {
                        q: `f(x) = (${u})${v}`,
                        a: `$$ ${ans} $$`,
                        steps: makeAlignedSteps(u, v, `2x`, vp, steps),
                        hint: "Kvadratisk uttrykk ganger rot med kjerneregel."
                    };
                });

                patterns.push(() => {
                    // ‚àö(ax + b) ¬∑ ‚àö(cx + d) - product of two roots
                    const c = r(1, 2);
                    const d = r(1, 3) * (Math.random() > 0.5 ? 1 : -1);
                    const u = `\\sqrt{${fmt(a,'x')} ${fmtNum(b)}}`;
                    const v = `\\sqrt{${fmt(c,'x')} ${fmtNum(d)}}`;
                    const up = `\\frac{${a}}{2\\sqrt{${fmt(a,'x')} ${fmtNum(b)}}}`;
                    const vp = `\\frac{${c}}{2\\sqrt{${fmt(c,'x')} ${fmtNum(d)}}}`;
                    const raw = `${up} \\cdot ${v} + ${u} \\cdot ${vp}`;
                    const ans = `f'(x) = ${raw}`;
                    const steps = `f'(x) &= u'v + uv' \\\\
&= ${raw}`;
                    return {
                        q: `f(x) = ${u} \\cdot ${v}`,
                        a: `$$ ${ans} $$`,
                        steps: makeAlignedSteps(u, v, up, vp, steps),
                        hint: "To r√∏tter med kjerneregel p√• begge."
                    };
                });
            }

            // Level 5: Expert
            else {
                patterns.push(() => {
                    // (x¬≤ + a) ¬∑ ‚àö(x¬≥ + bx + c) - quadratic times cubic root
                    const c = r(1, 2);
                    const d = r(1, 3);
                    const u = `x^2 ${fmtNum(a)}`;
                    const v = `\\sqrt{x^3 ${fmtNum(c, true)}x ${fmtNum(d)}}`;
                    const vp = `\\frac{3x^2 ${fmtNum(c)}}{2\\sqrt{x^3 ${fmtNum(c, true)}x ${fmtNum(d)}}}`;
                    const raw = `2x \\cdot ${v} + (${u}) \\cdot ${vp}`;
                    const ans = `f'(x) = ${raw}`;
                    const steps = `f'(x) &= u'v + uv' \\\\
&= ${raw}`;
                    return {
                        q: `f(x) = (${u})${v}`,
                        a: `$$ ${ans} $$`,
                        steps: makeAlignedSteps(u, v, `2x`, vp, steps),
                        hint: "Avansert - rot av kubisk polynom."
                    };
                });

                patterns.push(() => {
                    // ‚àö(ax¬≤ + b) ¬∑ ‚àö(cx¬≤ + d) - product of quadratic roots
                    const c = r(1, 2);
                    const d = r(1, 3);
                    const u = `\\sqrt{${fmt(a,'x^2')} ${fmtNum(b)}}`;
                    const v = `\\sqrt{${fmt(c,'x^2')} ${fmtNum(d)}}`;
                    const up = `\\frac{${2*a}x}{2\\sqrt{${fmt(a,'x^2')} ${fmtNum(b)}}}`;
                    const vp = `\\frac{${2*c}x}{2\\sqrt{${fmt(c,'x^2')} ${fmtNum(d)}}}`;
                    const raw = `${up} \\cdot ${v} + ${u} \\cdot ${vp}`;
                    const ans = `f'(x) = ${raw}`;
                    const steps = `f'(x) &= u'v + uv' \\\\
&= ${raw}`;
                    return {
                        q: `f(x) = ${u} \\cdot ${v}`,
                        a: `$$ ${ans} $$`,
                        steps: makeAlignedSteps(u, v, up, vp, steps),
                        hint: "To kvadratiske r√∏tter - kompleks kjerneregel."
                    };
                });
            }

            const pattern = patterns[r(0, patterns.length - 1)];
            const prob = pattern();
            add('product', lvl, 'root', prob.q, prob.a, prob.steps, prob.hint);
        }

        function generateProductExp(lvl, a, b, n, add, makeAlignedSteps, par, r) {
            const patterns = [];

            // Level 1: Easy basics
            if (lvl === 1) {
                patterns.push(() => {
                    // x ¬∑ e^x - simple product
                    const raw = `1 \\cdot e^x + x \\cdot e^x`;
                    const factored = `e^x(1 + x)`;
                    const ans = `f'(x) = ${factored}`;
                    const steps = `f'(x) &= u'v + uv' \\\\
&= ${raw} \\\\
&= ${factored}`;
                    return {
                        q: `f(x) = xe^x`,
                        a: `$$ ${ans} $$`,
                        steps: makeAlignedSteps(`x`, `e^x`, `1`, `e^x`, steps),
                        hint: "Klassisk eksempel - faktoriser med e^x."
                    };
                });

                patterns.push(() => {
                    // (x + a) ¬∑ e^x - linear times exponential
                    const u = `x ${fmtNum(a)}`;
                    const raw = `1 \\cdot e^x + (${u}) \\cdot e^x`;
                    const factored = `e^x(1 + ${u})`;
                    const simp = `e^x(x ${fmtNum(a + 1)})`;
                    const ans = `f'(x) = ${simp}`;
                    const steps = `f'(x) &= u'v + uv' \\\\
&= ${raw} \\\\
&= ${factored} \\\\
&= ${simp}`;
                    return {
                        q: `f(x) = (${u})e^x`,
                        a: `$$ ${ans} $$`,
                        steps: makeAlignedSteps(u, `e^x`, `1`, `e^x`, steps),
                        hint: "Line√¶rt uttrykk ganger e^x."
                    };
                });
            }

            // Level 2: Chain rules
            else if (lvl === 2) {
                patterns.push(() => {
                    // x¬≤ ¬∑ e^x - quadratic times exponential
                    const raw = `2x \\cdot e^x + x^2 \\cdot e^x`;
                    const factored = `e^x(2x + x^2)`;
                    const simp = `xe^x(2 + x)`;
                    const ans = `f'(x) = ${simp}`;
                    const steps = `f'(x) &= u'v + uv' \\\\
&= ${raw} \\\\
&= ${factored} \\\\
&= ${simp}`;
                    return {
                        q: `f(x) = x^2e^x`,
                        a: `$$ ${ans} $$`,
                        steps: makeAlignedSteps(`x^2`, `e^x`, `2x`, `e^x`, steps),
                        hint: "x¬≤ ganger e^x - faktoriser."
                    };
                });

                patterns.push(() => {
                    // x ¬∑ e^(ax) - linear times exponential with chain
                    const raw = `1 \\cdot e^{${a}x} + x \\cdot ${a}e^{${a}x}`;
                    const factored = `e^{${a}x}(1 + ${a}x)`;
                    const ans = `f'(x) = ${factored}`;
                    const steps = `f'(x) &= u'v + uv' \\\\
&= ${raw} \\\\
&= ${factored}`;
                    return {
                        q: `f(x) = xe^{${a}x}`,
                        a: `$$ ${ans} $$`,
                        steps: makeAlignedSteps(`x`, `e^{${a}x}`, `1`, `${a}e^{${a}x}`, steps),
                        hint: "Kjerneregel p√• eksponenten."
                    };
                });
            }

            // Level 3: More complex
            else if (lvl === 3) {
                patterns.push(() => {
                    // x¬≤ ¬∑ e^(ax) - quadratic times exponential with chain
                    const raw = `2x \\cdot e^{${a}x} + x^2 \\cdot ${a}e^{${a}x}`;
                    const factored = `xe^{${a}x}(2 + ${a}x)`;
                    const ans = `f'(x) = ${factored}`;
                    const steps = `f'(x) &= u'v + uv' \\\\
&= ${raw} \\\\
&= ${factored}`;
                    return {
                        q: `f(x) = x^2e^{${a}x}`,
                        a: `$$ ${ans} $$`,
                        steps: makeAlignedSteps(`x^2`, `e^{${a}x}`, `2x`, `${a}e^{${a}x}`, steps),
                        hint: "Kvadratisk ganger eksponential med kjerneregel."
                    };
                });

                patterns.push(() => {
                    // (ax + b) ¬∑ e^(cx) - both need chain rule
                    const c = r(1, 2);
                    const u = `${fmt(a,'x')} ${fmtNum(b)}`;
                    const v = `e^{${c}x}`;
                    const raw = `${a} \\cdot ${v} + (${u}) \\cdot ${c}${v}`;
                    const factored = `${v}(${a} + ${c}(${u}))`;
                    const ans = `f'(x) = ${factored}`;
                    const steps = `f'(x) &= u'v + uv' \\\\
&= ${raw} \\\\
&= ${factored}`;
                    return {
                        q: `f(x) = (${u})${v}`,
                        a: `$$ ${ans} $$`,
                        steps: makeAlignedSteps(u, v, `${a}`, `${c}${v}`, steps),
                        hint: "Kjerneregel p√• begge faktorer."
                    };
                });
            }

            // Level 4: Advanced
            else if (lvl === 4) {
                patterns.push(() => {
                    // (x¬≤ + a) ¬∑ e^(bx) - quadratic times exponential with chain
                    const c = r(1, 2);
                    const u = `x^2 ${fmtNum(a)}`;
                    const v = `e^{${c}x}`;
                    const raw = `2x \\cdot ${v} + (${u}) \\cdot ${c}${v}`;
                    const factored = `${v}(2x + ${c}(${u}))`;
                    const ans = `f'(x) = ${factored}`;
                    const steps = `f'(x) &= u'v + uv' \\\\
&= ${raw} \\\\
&= ${factored}`;
                    return {
                        q: `f(x) = (${u})${v}`,
                        a: `$$ ${ans} $$`,
                        steps: makeAlignedSteps(u, v, `2x`, `${c}${v}`, steps),
                        hint: "Kvadratisk uttrykk ganger eksponential."
                    };
                });

                patterns.push(() => {
                    // x ¬∑ e^(ax¬≤) - VERY challenging: exponential of quadratic
                    const inner = `${a}x^2`;
                    const v = `e^{${inner}}`;
                    const vp = `${2*a}x \\cdot e^{${inner}}`;
                    const raw = `1 \\cdot ${v} + x \\cdot ${vp}`;
                    const factored = `${v}(1 + ${2*a}x^2)`;
                    const ans = `f'(x) = ${factored}`;
                    const steps = `f'(x) &= u'v + uv' \\\\
&= ${raw} \\\\
&= ${factored}`;
                    return {
                        q: `f(x) = xe^{${inner}}`,
                        a: `$$ ${ans} $$`,
                        steps: makeAlignedSteps(`x`, v, `1`, vp, steps),
                        hint: "Vanskelig! Eksponent er kvadratisk."
                    };
                });
            }

            // Level 5: Expert
            else {
                patterns.push(() => {
                    // e^(ax) ¬∑ e^(bx) ¬∑ x - triple product with exponentials
                    const c = r(1, 2);
                    const u = `e^{${a}x}`;
                    const v = `e^{${c}x}`;
                    const w = `x`;
                    const ans = `f'(x) = ${a}${u} \\cdot ${v} \\cdot ${w} + ${u} \\cdot ${c}${v} \\cdot ${w} + ${u} \\cdot ${v} \\cdot 1`;
                    const steps = `f'(x) &= u'vw + uv'w + uvw' \\\\
&= ${ans}`;
                    return {
                        q: `f(x) = ${u} \\cdot ${v} \\cdot ${w}`,
                        a: `$$ ${ans} $$`,
                        steps: `$$
\\begin{aligned}
u &= ${u} & v &= ${v} & w &= ${w} \\\\
u' &= ${a}${u} & v' &= ${c}${v} & w' &= 1
\\end{aligned}
$$
$$
\\begin{aligned}
${steps}
\\end{aligned}
$$`,
                        hint: "Trippel-produkt! Bruk formelen: (uvw)' = u'vw + uv'w + uvw'"
                    };
                });

                patterns.push(() => {
                    // (x¬≤ + a) ¬∑ (x + b) ¬∑ e^(cx) - triple product
                    const c = r(1, 2);
                    const d = r(1, 2) * (Math.random() > 0.5 ? 1 : -1);
                    const u = `x^2 ${fmtNum(a)}`;
                    const v = `x ${fmtNum(d)}`;
                    const w = `e^{${c}x}`;
                    const ans = `f'(x) = 2x(${v})(${w}) + (${u}) \\cdot 1 \\cdot ${w} + (${u})(${v}) \\cdot ${c}${w}`;
                    const steps = `f'(x) &= u'vw + uv'w + uvw' \\\\
&= ${ans}`;
                    return {
                        q: `f(x) = (${u})(${v})${w}`,
                        a: `$$ ${ans} $$`,
                        steps: `$$
\\begin{aligned}
u &= ${u} & v &= ${v} & w &= ${w} \\\\
u' &= 2x & v' &= 1 & w' &= ${c}${w}
\\end{aligned}
$$
$$
\\begin{aligned}
${steps}
\\end{aligned}
$$`,
                        hint: "Trippel-produkt! Bruk formelen: (uvw)' = u'vw + uv'w + uvw'"
                    };
                });
            }

            const pattern = patterns[r(0, patterns.length - 1)];
            const prob = pattern();
            add('product', lvl, 'exp', prob.q, prob.a, prob.steps, prob.hint);
        }

        function generateProductLog(lvl, a, b, n, add, makeAlignedSteps, par, r) {
            const patterns = [];

            // Level 1: Easy basics
            if (lvl === 1) {
                patterns.push(() => {
                    // x ¬∑ ln(x) - simple product
                    const raw = `1 \\cdot \\ln x + x \\cdot \\frac{1}{x}`;
                    const simp = `\\ln x + 1`;
                    const ans = `f'(x) = ${simp}`;
                    const steps = `f'(x) &= u'v + uv' \\\\
&= ${raw} \\\\
&= ${simp}`;
                    return {
                        q: `f(x) = x\\ln x`,
                        a: `$$ ${ans} $$`,
                        steps: makeAlignedSteps(`x`, `\\ln x`, `1`, `\\frac{1}{x}`, steps),
                        hint: "Klassisk eksempel - x/x = 1."
                    };
                });

                patterns.push(() => {
                    // (x + a) ¬∑ ln(x) - linear times logarithm
                    const u = `x ${fmtNum(a)}`;
                    const raw = `1 \\cdot \\ln x + (${u}) \\cdot \\frac{1}{x}`;
                    const simp = `\\ln x + \\frac{${u}}{x}`;
                    const ans = `f'(x) = ${simp}`;
                    const steps = `f'(x) &= u'v + uv' \\\\
&= ${raw} \\\\
&= ${simp}`;
                    return {
                        q: `f(x) = (${u})\\ln x`,
                        a: `$$ ${ans} $$`,
                        steps: makeAlignedSteps(u, `\\ln x`, `1`, `\\frac{1}{x}`, steps),
                        hint: "Line√¶rt uttrykk ganger logaritme."
                    };
                });
            }

            // Level 2: Quadratic
            else if (lvl === 2) {
                patterns.push(() => {
                    // x¬≤ ¬∑ ln(x) - quadratic times logarithm
                    const raw = `2x \\cdot \\ln x + x^2 \\cdot \\frac{1}{x}`;
                    const simp = `2x\\ln x + x`;
                    const factored = `x(2\\ln x + 1)`;
                    const ans = `f'(x) = ${factored}`;
                    const steps = `f'(x) &= u'v + uv' \\\\
&= ${raw} \\\\
&= ${simp} \\\\
&= ${factored}`;
                    return {
                        q: `f(x) = x^2\\ln x`,
                        a: `$$ ${ans} $$`,
                        steps: makeAlignedSteps(`x^2`, `\\ln x`, `2x`, `\\frac{1}{x}`, steps),
                        hint: "x¬≤ ganger ln(x) - faktoriser."
                    };
                });

                patterns.push(() => {
                    // x ¬∑ ln(ax + b) - linear times logarithm with chain
                    const inner = `${fmt(a,'x')} ${fmtNum(b)}`;
                    const v = `\\ln(${inner})`;
                    const vp = `\\frac{${a}}{${inner}}`;
                    const raw = `1 \\cdot ${v} + x \\cdot ${vp}`;
                    const ans = `f'(x) = ${raw}`;
                    const steps = `f'(x) &= u'v + uv' \\\\
&= ${raw}`;
                    return {
                        q: `f(x) = x\\ln(${inner})`,
                        a: `$$ ${ans} $$`,
                        steps: makeAlignedSteps(`x`, v, `1`, vp, steps),
                        hint: "Kjerneregel p√• logaritmen."
                    };
                });
            }

            // Level 3: Chain rules
            else if (lvl === 3) {
                patterns.push(() => {
                    // x ¬∑ ln(ax + b) more complex
                    const inner = `${fmt(a,'x')} ${fmtNum(b)}`;
                    const v = `\\ln(${inner})`;
                    const vp = `\\frac{${a}}{${inner}}`;
                    const raw = `1 \\cdot ${v} + x \\cdot ${vp}`;
                    const ans = `f'(x) = \\ln(${inner}) + \\frac{${a}x}{${inner}}`;
                    const steps = `f'(x) &= u'v + uv' \\\\
&= ${raw} \\\\
&= ${ans}`;
                    return {
                        q: `f(x) = x\\ln(${inner})`,
                        a: `$$ ${ans} $$`,
                        steps: makeAlignedSteps(`x`, v, `1`, vp, steps),
                        hint: "Produktregel og kjerneregel kombinert."
                    };
                });

                patterns.push(() => {
                    // x¬≤ ¬∑ ln(ax + b) - quadratic times log with chain
                    const inner = `${fmt(a,'x')} ${fmtNum(b)}`;
                    const v = `\\ln(${inner})`;
                    const vp = `\\frac{${a}}{${inner}}`;
                    const raw = `2x \\cdot ${v} + x^2 \\cdot ${vp}`;
                    const ans = `f'(x) = ${raw}`;
                    const steps = `f'(x) &= u'v + uv' \\\\
&= ${raw}`;
                    return {
                        q: `f(x) = x^2\\ln(${inner})`,
                        a: `$$ ${ans} $$`,
                        steps: makeAlignedSteps(`x^2`, v, `2x`, vp, steps),
                        hint: "Kvadratisk ganger logaritme med kjerneregel."
                    };
                });
            }

            // Level 4: Advanced
            else if (lvl === 4) {
                patterns.push(() => {
                    // (x¬≤ + a) ¬∑ ln(bx + c) - quadratic times log with chain
                    const c = r(1, 2);
                    const d = r(1, 3);
                    const u = `x^2 ${fmtNum(a)}`;
                    const inner = `${fmt(c,'x')} ${fmtNum(d)}`;
                    const v = `\\ln(${inner})`;
                    const vp = `\\frac{${c}}{${inner}}`;
                    const raw = `2x \\cdot ${v} + (${u}) \\cdot ${vp}`;
                    const ans = `f'(x) = ${raw}`;
                    const steps = `f'(x) &= u'v + uv' \\\\
&= ${raw}`;
                    return {
                        q: `f(x) = (${u})\\ln(${inner})`,
                        a: `$$ ${ans} $$`,
                        steps: makeAlignedSteps(u, v, `2x`, vp, steps),
                        hint: "Kvadratisk uttrykk ganger logaritme."
                    };
                });

                patterns.push(() => {
                    // x ¬∑ ln(x¬≤ + a) - linear times log of quadratic
                    const inner = `x^2 ${fmtNum(a)}`;
                    const v = `\\ln(${inner})`;
                    const vp = `\\frac{2x}{${inner}}`;
                    const raw = `1 \\cdot ${v} + x \\cdot ${vp}`;
                    const ans = `f'(x) = ${v} + \\frac{2x^2}{${inner}}`;
                    const steps = `f'(x) &= u'v + uv' \\\\
&= ${raw} \\\\
&= ${ans}`;
                    return {
                        q: `f(x) = x\\ln(${inner})`,
                        a: `$$ ${ans} $$`,
                        steps: makeAlignedSteps(`x`, v, `1`, vp, steps),
                        hint: "Logaritme av kvadratisk uttrykk - kjerneregel."
                    };
                });
            }

            // Level 5: Expert
            else {
                patterns.push(() => {
                    // (x¬≤ + a) ¬∑ ln(bx¬≤ + c) - quadratic times log of quadratic
                    const c = r(1, 2);
                    const d = r(1, 3);
                    const u = `x^2 ${fmtNum(a)}`;
                    const inner = `${fmt(c,'x^2')} ${fmtNum(d)}`;
                    const v = `\\ln(${inner})`;
                    const vp = `\\frac{${2*c}x}{${inner}}`;
                    const raw = `2x \\cdot ${v} + (${u}) \\cdot ${vp}`;
                    const ans = `f'(x) = ${raw}`;
                    const steps = `f'(x) &= u'v + uv' \\\\
&= ${raw}`;
                    return {
                        q: `f(x) = (${u})\\ln(${inner})`,
                        a: `$$ ${ans} $$`,
                        steps: makeAlignedSteps(u, v, `2x`, vp, steps),
                        hint: "Avansert - logaritme av kvadratisk uttrykk."
                    };
                });

                patterns.push(() => {
                    // ln(ax + b) ¬∑ ln(cx + d) - product of two logarithms!
                    const c = r(1, 2);
                    const d = r(1, 3) * (Math.random() > 0.5 ? 1 : -1);
                    const inner1 = `${fmt(a,'x')} ${fmtNum(b)}`;
                    const inner2 = `${fmt(c,'x')} ${fmtNum(d)}`;
                    const u = `\\ln(${inner1})`;
                    const v = `\\ln(${inner2})`;
                    const up = `\\frac{${a}}{${inner1}}`;
                    const vp = `\\frac{${c}}{${inner2}}`;
                    const raw = `${up} \\cdot ${v} + ${u} \\cdot ${vp}`;
                    const ans = `f'(x) = ${raw}`;
                    const steps = `f'(x) &= u'v + uv' \\\\
&= ${raw}`;
                    return {
                        q: `f(x) = ${u} \\cdot ${v}`,
                        a: `$$ ${ans} $$`,
                        steps: makeAlignedSteps(u, v, up, vp, steps),
                        hint: "Ekstremt avansert - produkt av to logaritmer!"
                    };
                });
            }

            const pattern = patterns[r(0, patterns.length - 1)];
            const prob = pattern();
            add('product', lvl, 'log', prob.q, prob.a, prob.steps, prob.hint);
        }

        function generateQuotientProblem(type, lvl, a, b, n, add) {
            const r = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
            const par = (val) => val < 0 ? `(${val})` : val;

            // Helper to create aligned environment steps
            const makeAlignedSteps = (u, v, up, vp, steps) => {
                return `$$
\\begin{aligned}
u &= ${u} & v &= ${v} \\\\
u' &= ${up} & v' &= ${vp}
\\end{aligned}
$$
$$
\\begin{aligned}
${steps}
\\end{aligned}
$$`;
            };

            if (type === 'poly') {
                generateQuotientPoly(lvl, a, b, n, add, makeAlignedSteps, par, r);
            }
            else if (type === 'root') {
                generateQuotientRoot(lvl, a, b, n, add, makeAlignedSteps, par, r);
            }
            else if (type === 'exp') {
                generateQuotientExp(lvl, a, b, n, add, makeAlignedSteps, par, r);
            }
            else if (type === 'log') {
                generateQuotientLog(lvl, a, b, n, add, makeAlignedSteps, par, r);
            }
        }

        function generateQuotientPoly(lvl, a, b, n, add, makeAlignedSteps, par, r) {
            const patterns = [];

            // Level 1: Basic linear/linear, quadratic/linear
            if (lvl === 1) {
                patterns.push(() => {
                    // (ax + b)/(cx + d) - linear over linear
                    const c = r(1, 3);
                    const d = r(1, 4) * (Math.random() > 0.5 ? 1 : -1);
                    const num = `${fmt(a,'x')} ${fmtNum(b)}`;
                    const denom = `${fmt(c,'x')} ${fmtNum(d)}`;
                    const numDeriv = `${a*c} - ${a*c}`;
                    const rawNum = `${a}(${denom}) - (${num})(${c})`;
                    const simplifiedNum = `${a*d - b*c}`;
                    const ans = `f'(x) = \\frac{${simplifiedNum}}{(${denom})^2}`;
                    const steps = `f'(x) &= \\frac{u'v - uv'}{v^2} \\\\
&= \\frac{${rawNum}}{(${denom})^2} \\\\
&= \\frac{${simplifiedNum}}{(${denom})^2}`;
                    return {
                        q: `f(x) = \\frac{${num}}{${denom}}`,
                        a: `$$ ${ans} $$`,
                        steps: makeAlignedSteps(num, denom, `${a}`, `${c}`, steps),
                        hint: "Linear over linear - konstantene forsvinner ved derivasjon."
                    };
                });

                patterns.push(() => {
                    // x^2/(x + a) - quadratic over linear
                    const denom = `x ${fmtNum(a)}`;
                    const rawNum = `2x(${denom}) - x^2 \\cdot 1`;
                    const expandedNum = `2x^2 ${fmtNum(2*a, true)}x - x^2`;
                    const simplifiedNum = `x^2 ${fmtNum(2*a, true)}x`;
                    const factoredNum = `x(x ${fmtNum(2*a)})`;
                    const ans = `f'(x) = \\frac{${factoredNum}}{(${denom})^2}`;
                    const steps = `f'(x) &= \\frac{u'v - uv'}{v^2} \\\\
&= \\frac{${rawNum}}{(${denom})^2} \\\\
&= \\frac{${simplifiedNum}}{(${denom})^2} \\\\
&= \\frac{${factoredNum}}{(${denom})^2}`;
                    return {
                        q: `f(x) = \\frac{x^2}{${denom}}`,
                        a: `$$ ${ans} $$`,
                        steps: makeAlignedSteps(`x^2`, denom, `2x`, `1`, steps),
                        hint: "Kvadratisk polynom over line√¶rt uttrykk."
                    };
                });
            }

            // Level 2: Linear/quadratic, quadratic/quadratic
            else if (lvl === 2) {
                patterns.push(() => {
                    // x/(x^2 + a) - linear over quadratic
                    const denom = `x^2 ${fmtNum(a)}`;
                    const rawNum = `1 \\cdot (${denom}) - x \\cdot 2x`;
                    const simplifiedNum = `${fmtNum(a, true)} - x^2`;
                    const ans = `f'(x) = \\frac{${simplifiedNum}}{(${denom})^2}`;
                    const steps = `f'(x) &= \\frac{u'v - uv'}{v^2} \\\\
&= \\frac{${rawNum}}{(${denom})^2} \\\\
&= \\frac{${simplifiedNum}}{(${denom})^2}`;
                    return {
                        q: `f(x) = \\frac{x}{${denom}}`,
                        a: `$$ ${ans} $$`,
                        steps: makeAlignedSteps(`x`, denom, `1`, `2x`, steps),
                        hint: "Line√¶r over kvadratisk."
                    };
                });

                patterns.push(() => {
                    // (x + b)/(x^2 + a) - linear over quadratic
                    const num = `x ${fmtNum(b)}`;
                    const denom = `x^2 ${fmtNum(a)}`;
                    const rawNum = `1 \\cdot (${denom}) - (${num}) \\cdot 2x`;
                    const expandedNum = `x^2 ${fmtNum(a)} - 2x^2 ${fmtNum(2*b)}x`;
                    const simplifiedNum = `-x^2 ${fmtNum(-2*b)}x ${fmtNum(a)}`;
                    const ans = `f'(x) = \\frac{${simplifiedNum}}{(${denom})^2}`;
                    const steps = `f'(x) &= \\frac{u'v - uv'}{v^2} \\\\
&= \\frac{${rawNum}}{(${denom})^2} \\\\
&= \\frac{${simplifiedNum}}{(${denom})^2}`;
                    return {
                        q: `f(x) = \\frac{${num}}{${denom}}`,
                        a: `$$ ${ans} $$`,
                        steps: makeAlignedSteps(num, denom, `1`, `2x`, steps),
                        hint: "Line√¶r over kvadratisk - ekspander teller."
                    };
                });
            }

            // Level 3: Chain rule integration, squared terms
            else if (lvl === 3) {
                patterns.push(() => {
                    // (ax + b)^2/(x + c) - squared numerator
                    const c = r(1, 3) * (Math.random() > 0.5 ? 1 : -1);
                    const num = `(${fmt(a,'x')} ${fmtNum(b)})^2`;
                    const denom = `x ${fmtNum(c)}`;
                    const numDeriv = `2(${fmt(a,'x')} ${fmtNum(b)}) \\cdot ${a}`;
                    const rawNum = `${numDeriv}(${denom}) - ${num} \\cdot 1`;
                    const ans = `f'(x) = \\frac{${numDeriv}(${denom}) - ${num}}{(${denom})^2}`;
                    const steps = `f'(x) &= \\frac{u'v - uv'}{v^2} \\\\
&= \\frac{${rawNum}}{(${denom})^2}`;
                    return {
                        q: `f(x) = \\frac{${num}}{${denom}}`,
                        a: `$$ ${ans} $$`,
                        steps: makeAlignedSteps(num, denom, numDeriv, `1`, steps),
                        hint: "Kvadrert teller - bruk kjerneregel."
                    };
                });

                patterns.push(() => {
                    // x^3/(x^2 + a) - cubic over quadratic
                    const denom = `x^2 ${fmtNum(a)}`;
                    const rawNum = `3x^2(${denom}) - x^3 \\cdot 2x`;
                    const expandedNum = `3x^4 ${fmtNum(3*a, true)}x^2 - 2x^4`;
                    const simplifiedNum = `x^4 ${fmtNum(3*a, true)}x^2`;
                    const factoredNum = `x^2(x^2 ${fmtNum(3*a)})`;
                    const ans = `f'(x) = \\frac{${factoredNum}}{(${denom})^2}`;
                    const steps = `f'(x) &= \\frac{u'v - uv'}{v^2} \\\\
&= \\frac{${rawNum}}{(${denom})^2} \\\\
&= \\frac{${simplifiedNum}}{(${denom})^2} \\\\
&= \\frac{${factoredNum}}{(${denom})^2}`;
                    return {
                        q: `f(x) = \\frac{x^3}{${denom}}`,
                        a: `$$ ${ans} $$`,
                        steps: makeAlignedSteps(`x^3`, denom, `3x^2`, `2x`, steps),
                        hint: "Kubisk over kvadratisk - faktoriser teller."
                    };
                });
            }

            // Level 4: Complex quadratic expressions
            else if (lvl === 4) {
                patterns.push(() => {
                    // (x^2 + b)/(x^2 + a) - quadratic over quadratic
                    const num = `x^2 ${fmtNum(b)}`;
                    const denom = `x^2 ${fmtNum(a)}`;
                    const rawNum = `2x(${denom}) - (${num}) \\cdot 2x`;
                    const expandedNum = `2x^3 ${fmtNum(2*a, true)}x - 2x^3 ${fmtNum(2*b)}x`;
                    const simplifiedNum = `${2*a - 2*b}x`;
                    const ans = `f'(x) = \\frac{${simplifiedNum}}{(${denom})^2}`;
                    const steps = `f'(x) &= \\frac{u'v - uv'}{v^2} \\\\
&= \\frac{${rawNum}}{(${denom})^2} \\\\
&= \\frac{${simplifiedNum}}{(${denom})^2}`;
                    return {
                        q: `f(x) = \\frac{${num}}{${denom}}`,
                        a: `$$ ${ans} $$`,
                        steps: makeAlignedSteps(num, denom, `2x`, `2x`, steps),
                        hint: "Kvadratisk over kvadratisk - mye forenkles."
                    };
                });

                patterns.push(() => {
                    // (ax + b)/(x^2 + c) - linear over quadratic with coefficients
                    const c = r(1, 4);
                    const num = `${fmt(a,'x')} ${fmtNum(b)}`;
                    const denom = `x^2 ${fmtNum(c)}`;
                    const rawNum = `${a}(${denom}) - (${num}) \\cdot 2x`;
                    const expandedNum = `${a}x^2 ${fmtNum(a*c)} - 2x^2 ${fmtNum(2*b)}x`;
                    const simplifiedNum = `${a-2}x^2 ${fmtNum(-2*b)}x ${fmtNum(a*c)}`;
                    const ans = `f'(x) = \\frac{${simplifiedNum}}{(${denom})^2}`;
                    const steps = `f'(x) &= \\frac{u'v - uv'}{v^2} \\\\
&= \\frac{${rawNum}}{(${denom})^2}`;
                    return {
                        q: `f(x) = \\frac{${num}}{${denom}}`,
                        a: `$$ ${ans} $$`,
                        steps: makeAlignedSteps(num, denom, `${a}`, `2x`, steps),
                        hint: "Line√¶r over kvadratisk med koeffisienter."
                    };
                });
            }

            // Level 5: Expert - cubic polynomials
            else {
                patterns.push(() => {
                    // (x^2 + a)/(x^3 + b) - quadratic over cubic
                    const num = `x^2 ${fmtNum(a)}`;
                    const denom = `x^3 ${fmtNum(b)}`;
                    const rawNum = `2x(${denom}) - (${num}) \\cdot 3x^2`;
                    const ans = `f'(x) = \\frac{2x(${denom}) - 3x^2(${num})}{(${denom})^2}`;
                    const steps = `f'(x) &= \\frac{u'v - uv'}{v^2} \\\\
&= \\frac{${rawNum}}{(${denom})^2}`;
                    return {
                        q: `f(x) = \\frac{${num}}{${denom}}`,
                        a: `$$ ${ans} $$`,
                        steps: makeAlignedSteps(num, denom, `2x`, `3x^2`, steps),
                        hint: "Kvadratisk over kubisk polynom."
                    };
                });

                patterns.push(() => {
                    // x^n/(x^m + a) where n, m vary
                    const m = r(2, 3);
                    const num = `x${fmtPow(n)}`;
                    const denom = `x${fmtPow(m)} ${fmtNum(a)}`;
                    const rawNum = `${n}x${fmtPow(n-1)}(${denom}) - x${fmtPow(n)} \\cdot ${m}x${fmtPow(m-1)}`;
                    const ans = `f'(x) = \\frac{${rawNum}}{(${denom})^2}`;
                    const steps = `f'(x) &= \\frac{u'v - uv'}{v^2} \\\\
&= \\frac{${rawNum}}{(${denom})^2}`;
                    return {
                        q: `f(x) = \\frac{${num}}{${denom}}`,
                        a: `$$ ${ans} $$`,
                        steps: makeAlignedSteps(num, denom, `${n}x${fmtPow(n-1)}`, `${m}x${fmtPow(m-1)}`, steps),
                        hint: "H√∏yere grads polynomer."
                    };
                });
            }

            const pattern = patterns[r(0, patterns.length - 1)];
            const prob = pattern();
            add('quotient', lvl, 'poly', prob.q, prob.a, prob.steps, prob.hint);
        }

        function generateQuotientRoot(lvl, a, b, n, add, makeAlignedSteps, par, r) {
            const patterns = [];

            // Level 1: Basic root patterns
            if (lvl === 1) {
                patterns.push(() => {
                    // ‚àöx/(x + a) - root over linear (current pattern, keep it)
                    const denom = `x ${fmtNum(a)}`;
                    const rawNum = `\\frac{1}{2\\sqrt{x}}(${denom}) - \\sqrt{x}`;
                    const combinedNum = `\\frac{(${denom}) - 2x}{2\\sqrt{x}}`;
                    const simpNum = `${fmtNum(a, true)} - x`;
                    const ans = `f'(x) = \\frac{${simpNum}}{2\\sqrt{x}(${denom})^2}`;
                    const steps = `f'(x) &= \\frac{u'v - uv'}{v^2} \\\\
&= \\frac{${rawNum}}{(${denom})^2} \\\\
&= \\frac{${combinedNum}}{(${denom})^2} \\\\
&= \\frac{${simpNum}}{2\\sqrt{x}(${denom})^2}`;
                    return {
                        q: `f(x) = \\frac{\\sqrt{x}}{${denom}}`,
                        a: `$$ ${ans} $$`,
                        steps: makeAlignedSteps(`\\sqrt{x}`, denom, `\\frac{1}{2\\sqrt{x}}`, `1`, steps),
                        hint: "Kvadratrot over line√¶rt uttrykk."
                    };
                });

                patterns.push(() => {
                    // ‚àöx/x = x^(-1/2) - simplifies nicely
                    const rawNum = `\\frac{1}{2\\sqrt{x}} \\cdot x - \\sqrt{x} \\cdot 1`;
                    const combinedNum = `\\frac{x - 2x}{2\\sqrt{x}}`;
                    const simpNum = `-x`;
                    const ans = `f'(x) = \\frac{-1}{2\\sqrt{x}}`;
                    const steps = `f'(x) &= \\frac{u'v - uv'}{v^2} \\\\
&= \\frac{${rawNum}}{x^2} \\\\
&= \\frac{${combinedNum}}{x^2} \\\\
&= \\frac{-x}{2\\sqrt{x} \\cdot x^2} \\\\
&= \\frac{-1}{2\\sqrt{x}x} \\\\
&= \\frac{-1}{2x\\sqrt{x}}`;
                    return {
                        q: `f(x) = \\frac{\\sqrt{x}}{x}`,
                        a: `$$ ${ans} $$`,
                        steps: makeAlignedSteps(`\\sqrt{x}`, `x`, `\\frac{1}{2\\sqrt{x}}`, `1`, steps),
                        hint: "Kan ogs√• skrives som x^{-1/2} og deriveres direkte."
                    };
                });
            }

            // Level 2: Root over quadratic, linear over root
            else if (lvl === 2) {
                patterns.push(() => {
                    // ‚àöx/(x^2 + a) - root over quadratic
                    const denom = `x^2 ${fmtNum(a)}`;
                    const rawNum = `\\frac{1}{2\\sqrt{x}}(${denom}) - \\sqrt{x} \\cdot 2x`;
                    const combinedNum = `\\frac{(${denom}) - 4x^2}{2\\sqrt{x}}`;
                    const simpNum = `${fmtNum(a, true)} - 3x^2`;
                    const ans = `f'(x) = \\frac{${simpNum}}{2\\sqrt{x}(${denom})^2}`;
                    const steps = `f'(x) &= \\frac{u'v - uv'}{v^2} \\\\
&= \\frac{${rawNum}}{(${denom})^2} \\\\
&= \\frac{${combinedNum}}{(${denom})^2} \\\\
&= \\frac{${simpNum}}{2\\sqrt{x}(${denom})^2}`;
                    return {
                        q: `f(x) = \\frac{\\sqrt{x}}{${denom}}`,
                        a: `$$ ${ans} $$`,
                        steps: makeAlignedSteps(`\\sqrt{x}`, denom, `\\frac{1}{2\\sqrt{x}}`, `2x`, steps),
                        hint: "Rot over kvadratisk uttrykk."
                    };
                });

                patterns.push(() => {
                    // (x + a)/‚àöx - linear over root
                    const num = `x ${fmtNum(a)}`;
                    const rawNum = `1 \\cdot \\sqrt{x} - (${num}) \\cdot \\frac{1}{2\\sqrt{x}}`;
                    const combinedNum = `\\frac{2x - (${num})}{2\\sqrt{x}}`;
                    const simpNum = `x ${fmtNum(-a)}`;
                    const ans = `f'(x) = \\frac{${simpNum}}{2x}`;
                    const steps = `f'(x) &= \\frac{u'v - uv'}{v^2} \\\\
&= \\frac{${rawNum}}{x} \\\\
&= \\frac{${combinedNum}}{x} \\\\
&= \\frac{${simpNum}}{2x}`;
                    return {
                        q: `f(x) = \\frac{${num}}{\\sqrt{x}}`,
                        a: `$$ ${ans} $$`,
                        steps: makeAlignedSteps(num, `\\sqrt{x}`, `1`, `\\frac{1}{2\\sqrt{x}}`, steps),
                        hint: "Line√¶r over kvadratrot."
                    };
                });
            }

            // Level 3: Root with chain rule
            else if (lvl === 3) {
                patterns.push(() => {
                    // ‚àö(ax + b)/(x + c) - root with chain in numerator
                    const c = r(1, 3) * (Math.random() > 0.5 ? 1 : -1);
                    const num = `\\sqrt{${fmt(a,'x')} ${fmtNum(b)}}`;
                    const denom = `x ${fmtNum(c)}`;
                    const numDeriv = `\\frac{${a}}{2\\sqrt{${fmt(a,'x')} ${fmtNum(b)}}}`;
                    const rawNum = `${numDeriv}(${denom}) - ${num}`;
                    const ans = `f'(x) = \\frac{${rawNum}}{(${denom})^2}`;
                    const steps = `f'(x) &= \\frac{u'v - uv'}{v^2} \\\\
&= \\frac{${rawNum}}{(${denom})^2}`;
                    return {
                        q: `f(x) = \\frac{${num}}{${denom}}`,
                        a: `$$ ${ans} $$`,
                        steps: makeAlignedSteps(num, denom, numDeriv, `1`, steps),
                        hint: "Rot med kjerneregel i teller."
                    };
                });

                patterns.push(() => {
                    // x/‚àö(ax + b) - linear over root with chain
                    const num = `x`;
                    const denom = `\\sqrt{${fmt(a,'x')} ${fmtNum(b)}}`;
                    const denomDeriv = `\\frac{${a}}{2\\sqrt{${fmt(a,'x')} ${fmtNum(b)}}}`;
                    const rawNum = `1 \\cdot ${denom} - x \\cdot ${denomDeriv}`;
                    const ans = `f'(x) = \\frac{${rawNum}}{${fmt(a,'x')} ${fmtNum(b)}}`;
                    const steps = `f'(x) &= \\frac{u'v - uv'}{v^2} \\\\
&= \\frac{${rawNum}}{(${denom})^2} \\\\
&= \\frac{${rawNum}}{${fmt(a,'x')} ${fmtNum(b)}}`;
                    return {
                        q: `f(x) = \\frac{${num}}{${denom}}`,
                        a: `$$ ${ans} $$`,
                        steps: makeAlignedSteps(num, denom, `1`, denomDeriv, steps),
                        hint: "Rot med kjerneregel i nevner."
                    };
                });
            }

            // Level 4: Complex root expressions
            else if (lvl === 4) {
                patterns.push(() => {
                    // x^2/‚àö(ax + b) - quadratic over root
                    const num = `x^2`;
                    const denom = `\\sqrt{${fmt(a,'x')} ${fmtNum(b)}}`;
                    const denomDeriv = `\\frac{${a}}{2\\sqrt{${fmt(a,'x')} ${fmtNum(b)}}}`;
                    const rawNum = `2x \\cdot ${denom} - x^2 \\cdot ${denomDeriv}`;
                    const ans = `f'(x) = \\frac{${rawNum}}{${fmt(a,'x')} ${fmtNum(b)}}`;
                    const steps = `f'(x) &= \\frac{u'v - uv'}{v^2} \\\\
&= \\frac{${rawNum}}{(${denom})^2} \\\\
&= \\frac{${rawNum}}{${fmt(a,'x')} ${fmtNum(b)}}`;
                    return {
                        q: `f(x) = \\frac{${num}}{${denom}}`,
                        a: `$$ ${ans} $$`,
                        steps: makeAlignedSteps(num, denom, `2x`, denomDeriv, steps),
                        hint: "Kvadratisk over rot med kjerneregel."
                    };
                });

                patterns.push(() => {
                    // ‚àö(x^2 + a)/x - complex root over x
                    const num = `\\sqrt{x^2 ${fmtNum(a)}}`;
                    const numDeriv = `\\frac{2x}{2\\sqrt{x^2 ${fmtNum(a)}}}`;
                    const denom = `x`;
                    const rawNum = `${numDeriv} \\cdot x - ${num} \\cdot 1`;
                    const ans = `f'(x) = \\frac{${rawNum}}{x^2}`;
                    const steps = `f'(x) &= \\frac{u'v - uv'}{v^2} \\\\
&= \\frac{${rawNum}}{x^2}`;
                    return {
                        q: `f(x) = \\frac{${num}}{${denom}}`,
                        a: `$$ ${ans} $$`,
                        steps: makeAlignedSteps(num, denom, numDeriv, `1`, steps),
                        hint: "Rot av kvadratisk uttrykk over x."
                    };
                });
            }

            // Level 5: Expert - root ratios, cubic roots
            else {
                patterns.push(() => {
                    // ‚àö(x^3 + a)/(x^2 + b) - cubic root over quadratic
                    const num = `\\sqrt{x^3 ${fmtNum(a)}}`;
                    const numDeriv = `\\frac{3x^2}{2\\sqrt{x^3 ${fmtNum(a)}}}`;
                    const denom = `x^2 ${fmtNum(b)}`;
                    const rawNum = `${numDeriv}(${denom}) - ${num} \\cdot 2x`;
                    const ans = `f'(x) = \\frac{${rawNum}}{(${denom})^2}`;
                    const steps = `f'(x) &= \\frac{u'v - uv'}{v^2} \\\\
&= \\frac{${rawNum}}{(${denom})^2}`;
                    return {
                        q: `f(x) = \\frac{${num}}{${denom}}`,
                        a: `$$ ${ans} $$`,
                        steps: makeAlignedSteps(num, denom, numDeriv, `2x`, steps),
                        hint: "Rot av kubisk over kvadratisk."
                    };
                });

                patterns.push(() => {
                    // (x^2 + a)/‚àö(x^3 + b) - quadratic over cubic root
                    const num = `x^2 ${fmtNum(a)}`;
                    const denom = `\\sqrt{x^3 ${fmtNum(b)}}`;
                    const denomDeriv = `\\frac{3x^2}{2\\sqrt{x^3 ${fmtNum(b)}}}`;
                    const rawNum = `2x \\cdot ${denom} - (${num}) \\cdot ${denomDeriv}`;
                    const ans = `f'(x) = \\frac{${rawNum}}{x^3 ${fmtNum(b)}}`;
                    const steps = `f'(x) &= \\frac{u'v - uv'}{v^2} \\\\
&= \\frac{${rawNum}}{(${denom})^2} \\\\
&= \\frac{${rawNum}}{x^3 ${fmtNum(b)}}`;
                    return {
                        q: `f(x) = \\frac{${num}}{${denom}}`,
                        a: `$$ ${ans} $$`,
                        steps: makeAlignedSteps(num, denom, `2x`, denomDeriv, steps),
                        hint: "Kvadratisk over rot av kubisk."
                    };
                });
            }

            const pattern = patterns[r(0, patterns.length - 1)];
            const prob = pattern();
            add('quotient', lvl, 'root', prob.q, prob.a, prob.steps, prob.hint);
        }

        function generateQuotientExp(lvl, a, b, n, add, makeAlignedSteps, par, r) {
            const patterns = [];

            // Level 1: Exponential over linear, linear over exponential
            if (lvl === 1) {
                patterns.push(() => {
                    // e^x/(x + a) - exponential over linear
                    const denom = `x ${fmtNum(a)}`;
                    const rawNum = `e^x(${denom}) - e^x \\cdot 1`;
                    const factoredNum = `e^x(${denom} - 1)`;
                    const simpDenom = `x ${fmtNum(a-1)}`;
                    const ans = `f'(x) = \\frac{e^x(${simpDenom})}{(${denom})^2}`;
                    const steps = `f'(x) &= \\frac{u'v - uv'}{v^2} \\\\
&= \\frac{${rawNum}}{(${denom})^2} \\\\
&= \\frac{e^x(${simpDenom})}{(${denom})^2}`;
                    return {
                        q: `f(x) = \\frac{e^x}{${denom}}`,
                        a: `$$ ${ans} $$`,
                        steps: makeAlignedSteps(`e^x`, denom, `e^x`, `1`, steps),
                        hint: "Eksponentialfunksjon over line√¶rt uttrykk."
                    };
                });

                patterns.push(() => {
                    // x/e^x - linear over exponential
                    const rawNum = `1 \\cdot e^x - x \\cdot e^x`;
                    const factoredNum = `e^x(1 - x)`;
                    const ans = `f'(x) = \\frac{1 - x}{e^x}`;
                    const steps = `f'(x) &= \\frac{u'v - uv'}{v^2} \\\\
&= \\frac{${rawNum}}{(e^x)^2} \\\\
&= \\frac{${factoredNum}}{e^{2x}} \\\\
&= \\frac{1 - x}{e^x}`;
                    return {
                        q: `f(x) = \\frac{x}{e^x}`,
                        a: `$$ ${ans} $$`,
                        steps: makeAlignedSteps(`x`, `e^x`, `1`, `e^x`, steps),
                        hint: "Line√¶r over eksponentialfunksjon."
                    };
                });
            }

            // Level 2: Exponential with chain, polynomial over exponential
            else if (lvl === 2) {
                patterns.push(() => {
                    // e^(ax)/(x + b) - exponential with chain over linear
                    const denom = `x ${fmtNum(b)}`;
                    const rawNum = `${a}e^{${a}x}(${denom}) - e^{${a}x} \\cdot 1`;
                    const factoredNum = `e^{${a}x}(${a}(${denom}) - 1)`;
                    const simpNum = `${a}x ${fmtNum(a*b - 1)}`;
                    const ans = `f'(x) = \\frac{e^{${a}x}(${simpNum})}{(${denom})^2}`;
                    const steps = `f'(x) &= \\frac{u'v - uv'}{v^2} \\\\
&= \\frac{${rawNum}}{(${denom})^2} \\\\
&= \\frac{e^{${a}x}(${simpNum})}{(${denom})^2}`;
                    return {
                        q: `f(x) = \\frac{e^{${a}x}}{${denom}}`,
                        a: `$$ ${ans} $$`,
                        steps: makeAlignedSteps(`e^{${a}x}`, denom, `${a}e^{${a}x}`, `1`, steps),
                        hint: "Eksponential med kjerneregel over line√¶rt."
                    };
                });

                patterns.push(() => {
                    // x^2/e^x - quadratic over exponential
                    const rawNum = `2x \\cdot e^x - x^2 \\cdot e^x`;
                    const factoredNum = `e^x(2x - x^2)`;
                    const simpNum = `x(2 - x)`;
                    const ans = `f'(x) = \\frac{${simpNum}}{e^x}`;
                    const steps = `f'(x) &= \\frac{u'v - uv'}{v^2} \\\\
&= \\frac{${rawNum}}{e^{2x}} \\\\
&= \\frac{${factoredNum}}{e^{2x}} \\\\
&= \\frac{${simpNum}}{e^x}`;
                    return {
                        q: `f(x) = \\frac{x^2}{e^x}`,
                        a: `$$ ${ans} $$`,
                        steps: makeAlignedSteps(`x^2`, `e^x`, `2x`, `e^x`, steps),
                        hint: "Kvadratisk over eksponential."
                    };
                });
            }

            // Level 3: More complex chain rules
            else if (lvl === 3) {
                patterns.push(() => {
                    // e^(ax)/(x^2 + b) - exponential with chain over quadratic
                    const denom = `x^2 ${fmtNum(b)}`;
                    const rawNum = `${a}e^{${a}x}(${denom}) - e^{${a}x} \\cdot 2x`;
                    const factoredNum = `e^{${a}x}(${a}(${denom}) - 2x)`;
                    const ans = `f'(x) = \\frac{${factoredNum}}{(${denom})^2}`;
                    const steps = `f'(x) &= \\frac{u'v - uv'}{v^2} \\\\
&= \\frac{${rawNum}}{(${denom})^2} \\\\
&= \\frac{${factoredNum}}{(${denom})^2}`;
                    return {
                        q: `f(x) = \\frac{e^{${a}x}}{${denom}}`,
                        a: `$$ ${ans} $$`,
                        steps: makeAlignedSteps(`e^{${a}x}`, denom, `${a}e^{${a}x}`, `2x`, steps),
                        hint: "Eksponential over kvadratisk."
                    };
                });

                patterns.push(() => {
                    // (x^2 + a)/e^(bx) - quadratic over exponential with chain
                    const num = `x^2 ${fmtNum(a)}`;
                    const denom = `e^{${b}x}`;
                    const rawNum = `2x \\cdot ${denom} - (${num}) \\cdot ${b}${denom}`;
                    const factoredNum = `${denom}(2x - ${b}(${num}))`;
                    const simpNum = `2x - ${b}x^2 ${fmtNum(b*a)}`;
                    const ans = `f'(x) = \\frac{${simpNum}}{${denom}}`;
                    const steps = `f'(x) &= \\frac{u'v - uv'}{v^2} \\\\
&= \\frac{${rawNum}}{(${denom})^2} \\\\
&= \\frac{${simpNum}}{${denom}}`;
                    return {
                        q: `f(x) = \\frac{${num}}{${denom}}`,
                        a: `$$ ${ans} $$`,
                        steps: makeAlignedSteps(num, denom, `2x`, `${b}${denom}`, steps),
                        hint: "Kvadratisk over eksponential med kjerneregel."
                    };
                });
            }

            // Level 4: Product in numerator, complex expressions
            else if (lvl === 4) {
                patterns.push(() => {
                    // x¬∑e^x/(x^2 + a) - product in numerator
                    const num = `x \\cdot e^x`;
                    const numDeriv = `e^x + x \\cdot e^x`;
                    const denom = `x^2 ${fmtNum(a)}`;
                    const rawNum = `(${numDeriv})(${denom}) - ${num} \\cdot 2x`;
                    const ans = `f'(x) = \\frac{(${numDeriv})(${denom}) - 2x^2e^x}{(${denom})^2}`;
                    const steps = `f'(x) &= \\frac{u'v - uv'}{v^2} \\\\
&= \\frac{${rawNum}}{(${denom})^2}`;
                    return {
                        q: `f(x) = \\frac{${num}}{${denom}}`,
                        a: `$$ ${ans} $$`,
                        steps: makeAlignedSteps(num, denom, numDeriv, `2x`, steps),
                        hint: "Produkt i teller - bruk produktregel f√∏rst."
                    };
                });

                patterns.push(() => {
                    // e^(ax + b)/(x^2 + c) - shifted exponential over quadratic
                    const c = r(1, 4);
                    const num = `e^{${fmt(a,'x')} ${fmtNum(b)}}`;
                    const numDeriv = `${a}e^{${fmt(a,'x')} ${fmtNum(b)}}`;
                    const denom = `x^2 ${fmtNum(c)}`;
                    const rawNum = `${numDeriv}(${denom}) - ${num} \\cdot 2x`;
                    const ans = `f'(x) = \\frac{${rawNum}}{(${denom})^2}`;
                    const steps = `f'(x) &= \\frac{u'v - uv'}{v^2} \\\\
&= \\frac{${rawNum}}{(${denom})^2}`;
                    return {
                        q: `f(x) = \\frac{${num}}{${denom}}`,
                        a: `$$ ${ans} $$`,
                        steps: makeAlignedSteps(num, denom, numDeriv, `2x`, steps),
                        hint: "Eksponential med line√¶r ekponent."
                    };
                });
            }

            // Level 5: Expert - polynomial-exponential products, complex chains
            else {
                patterns.push(() => {
                    // x^2¬∑e^(ax)/(bx + c) - quadratic-exponential product over linear
                    const c = r(1, 3);
                    const num = `x^2 \\cdot e^{${a}x}`;
                    const numDeriv = `2x \\cdot e^{${a}x} + x^2 \\cdot ${a}e^{${a}x}`;
                    const denom = `${fmt(b,'x')} ${fmtNum(c)}`;
                    const rawNum = `(${numDeriv})(${denom}) - ${num} \\cdot ${b}`;
                    const ans = `f'(x) = \\frac{${rawNum}}{(${denom})^2}`;
                    const steps = `f'(x) &= \\frac{u'v - uv'}{v^2} \\\\
&= \\frac{${rawNum}}{(${denom})^2}`;
                    return {
                        q: `f(x) = \\frac{${num}}{${denom}}`,
                        a: `$$ ${ans} $$`,
                        steps: makeAlignedSteps(num, denom, numDeriv, `${b}`, steps),
                        hint: "Produkt i teller - kombiner produkt- og kjerneregel."
                    };
                });

                patterns.push(() => {
                    // (ax + b)¬∑e^(cx)/(dx^2 + e) - linear-exponential product over quadratic
                    const c = r(1, 2);
                    const d = r(1, 2);
                    const e = r(1, 4);
                    const num = `(${fmt(a,'x')} ${fmtNum(b)}) \\cdot e^{${c}x}`;
                    const numDeriv = `${a}e^{${c}x} + (${fmt(a,'x')} ${fmtNum(b)}) \\cdot ${c}e^{${c}x}`;
                    const denom = `${fmt(d,'x^2')} ${fmtNum(e)}`;
                    const rawNum = `(${numDeriv})(${denom}) - ${num} \\cdot ${2*d}x`;
                    const ans = `f'(x) = \\frac{${rawNum}}{(${denom})^2}`;
                    const steps = `f'(x) &= \\frac{u'v - uv'}{v^2} \\\\
&= \\frac{${rawNum}}{(${denom})^2}`;
                    return {
                        q: `f(x) = \\frac{${num}}{${denom}}`,
                        a: `$$ ${ans} $$`,
                        steps: makeAlignedSteps(num, denom, numDeriv, `${2*d}x`, steps),
                        hint: "Avansert - produktregel i teller kombinert med br√∏kregel."
                    };
                });
            }

            const pattern = patterns[r(0, patterns.length - 1)];
            const prob = pattern();
            add('quotient', lvl, 'exp', prob.q, prob.a, prob.steps, prob.hint);
        }

        function generateQuotientLog(lvl, a, b, n, add, makeAlignedSteps, par, r) {
            const patterns = [];

            // Level 1: Basic logarithm patterns
            if (lvl === 1) {
                patterns.push(() => {
                    // ln(x)/x - logarithm over x (simpler than current x^n)
                    const rawNum = `\\frac{1}{x} \\cdot x - \\ln x \\cdot 1`;
                    const ans = `f'(x) = \\frac{1 - \\ln x}{x^2}`;
                    const steps = `f'(x) &= \\frac{u'v - uv'}{v^2} \\\\
&= \\frac{${rawNum}}{x^2} \\\\
&= \\frac{1 - \\ln x}{x^2}`;
                    return {
                        q: `f(x) = \\frac{\\ln x}{x}`,
                        a: `$$ ${ans} $$`,
                        steps: makeAlignedSteps(`\\ln x`, `x`, `\\frac{1}{x}`, `1`, steps),
                        hint: "Logaritme over x - klassisk oppgave."
                    };
                });

                patterns.push(() => {
                    // x/ln(x) - x over logarithm
                    const rawNum = `1 \\cdot \\ln x - x \\cdot \\frac{1}{x}`;
                    const ans = `f'(x) = \\frac{\\ln x - 1}{(\\ln x)^2}`;
                    const steps = `f'(x) &= \\frac{u'v - uv'}{v^2} \\\\
&= \\frac{${rawNum}}{(\\ln x)^2} \\\\
&= \\frac{\\ln x - 1}{(\\ln x)^2}`;
                    return {
                        q: `f(x) = \\frac{x}{\\ln x}`,
                        a: `$$ ${ans} $$`,
                        steps: makeAlignedSteps(`x`, `\\ln x`, `1`, `\\frac{1}{x}`, steps),
                        hint: "x over logaritme - interessant variant."
                    };
                });
            }

            // Level 2: Logarithm over quadratic, quadratic over logarithm
            else if (lvl === 2) {
                patterns.push(() => {
                    // ln(x)/(x + a) - logarithm over linear
                    const denom = `x ${fmtNum(a)}`;
                    const rawNum = `\\frac{1}{x}(${denom}) - \\ln x \\cdot 1`;
                    const expandedNum = `\\frac{${denom}}{x} - \\ln x`;
                    const combinedNum = `\\frac{${denom} - x\\ln x}{x}`;
                    const ans = `f'(x) = \\frac{${denom} - x\\ln x}{x(${denom})^2}`;
                    const steps = `f'(x) &= \\frac{u'v - uv'}{v^2} \\\\
&= \\frac{${rawNum}}{(${denom})^2} \\\\
&= \\frac{${combinedNum}}{(${denom})^2}`;
                    return {
                        q: `f(x) = \\frac{\\ln x}{${denom}}`,
                        a: `$$ ${ans} $$`,
                        steps: makeAlignedSteps(`\\ln x`, denom, `\\frac{1}{x}`, `1`, steps),
                        hint: "Logaritme over line√¶rt uttrykk."
                    };
                });

                patterns.push(() => {
                    // ln(x)/x^2 - logarithm over x squared (current pattern at level 2)
                    const rawNum = `\\frac{1}{x} \\cdot x^2 - \\ln x \\cdot 2x`;
                    const factoredNum = `x(1 - 2\\ln x)`;
                    const ans = `f'(x) = \\frac{1 - 2\\ln x}{x^3}`;
                    const steps = `f'(x) &= \\frac{u'v - uv'}{v^2} \\\\
&= \\frac{${rawNum}}{x^4} \\\\
&= \\frac{${factoredNum}}{x^4} \\\\
&= \\frac{1 - 2\\ln x}{x^3}`;
                    return {
                        q: `f(x) = \\frac{\\ln x}{x^2}`,
                        a: `$$ ${ans} $$`,
                        steps: makeAlignedSteps(`\\ln x`, `x^2`, `\\frac{1}{x}`, `2x`, steps),
                        hint: "Logaritme over x^2."
                    };
                });
            }

            // Level 3: Logarithm with chain rule
            else if (lvl === 3) {
                patterns.push(() => {
                    // ln(ax + b)/x - logarithm with chain over x
                    const num = `\\ln(${fmt(a,'x')} ${fmtNum(b)})`;
                    const numDeriv = `\\frac{${a}}{${fmt(a,'x')} ${fmtNum(b)}}`;
                    const rawNum = `${numDeriv} \\cdot x - ${num} \\cdot 1`;
                    const ans = `f'(x) = \\frac{${rawNum}}{x^2}`;
                    const steps = `f'(x) &= \\frac{u'v - uv'}{v^2} \\\\
&= \\frac{${rawNum}}{x^2}`;
                    return {
                        q: `f(x) = \\frac{${num}}{x}`,
                        a: `$$ ${ans} $$`,
                        steps: makeAlignedSteps(num, `x`, numDeriv, `1`, steps),
                        hint: "Logaritme med kjerneregel over x."
                    };
                });

                patterns.push(() => {
                    // ln(x)/‚àöx - logarithm over root
                    const rawNum = `\\frac{1}{x} \\cdot \\sqrt{x} - \\ln x \\cdot \\frac{1}{2\\sqrt{x}}`;
                    const combinedNum = `\\frac{2 - \\ln x}{2\\sqrt{x}}`;
                    const ans = `f'(x) = \\frac{2 - \\ln x}{2x}`;
                    const steps = `f'(x) &= \\frac{u'v - uv'}{v^2} \\\\
&= \\frac{${rawNum}}{x} \\\\
&= \\frac{${combinedNum}}{x} \\\\
&= \\frac{2 - \\ln x}{2x}`;
                    return {
                        q: `f(x) = \\frac{\\ln x}{\\sqrt{x}}`,
                        a: `$$ ${ans} $$`,
                        steps: makeAlignedSteps(`\\ln x`, `\\sqrt{x}`, `\\frac{1}{x}`, `\\frac{1}{2\\sqrt{x}}`, steps),
                        hint: "Logaritme over kvadratrot."
                    };
                });
            }

            // Level 4: More complex logarithm expressions
            else if (lvl === 4) {
                patterns.push(() => {
                    // ln(x^2 + a)/x - logarithm of quadratic over x
                    const num = `\\ln(x^2 ${fmtNum(a)})`;
                    const numDeriv = `\\frac{2x}{x^2 ${fmtNum(a)}}`;
                    const rawNum = `${numDeriv} \\cdot x - ${num} \\cdot 1`;
                    const ans = `f'(x) = \\frac{${rawNum}}{x^2}`;
                    const steps = `f'(x) &= \\frac{u'v - uv'}{v^2} \\\\
&= \\frac{${rawNum}}{x^2}`;
                    return {
                        q: `f(x) = \\frac{${num}}{x}`,
                        a: `$$ ${ans} $$`,
                        steps: makeAlignedSteps(num, `x`, numDeriv, `1`, steps),
                        hint: "Logaritme av kvadratisk uttrykk."
                    };
                });

                patterns.push(() => {
                    // ln(ax + b)/(x^2 + c) - logarithm with chain over quadratic
                    const c = r(1, 4);
                    const num = `\\ln(${fmt(a,'x')} ${fmtNum(b)})`;
                    const numDeriv = `\\frac{${a}}{${fmt(a,'x')} ${fmtNum(b)}}`;
                    const denom = `x^2 ${fmtNum(c)}`;
                    const rawNum = `${numDeriv}(${denom}) - ${num} \\cdot 2x`;
                    const ans = `f'(x) = \\frac{${rawNum}}{(${denom})^2}`;
                    const steps = `f'(x) &= \\frac{u'v - uv'}{v^2} \\\\
&= \\frac{${rawNum}}{(${denom})^2}`;
                    return {
                        q: `f(x) = \\frac{${num}}{${denom}}`,
                        a: `$$ ${ans} $$`,
                        steps: makeAlignedSteps(num, denom, numDeriv, `2x`, steps),
                        hint: "Logaritme med kjerneregel over kvadratisk."
                    };
                });
            }

            // Level 5: Expert - products with logarithms, complex expressions
            else {
                patterns.push(() => {
                    // x¬∑ln(ax + b)/(x^2 + c) - product with logarithm over quadratic
                    const c = r(1, 4);
                    const num = `x \\cdot \\ln(${fmt(a,'x')} ${fmtNum(b)})`;
                    const numDeriv = `\\ln(${fmt(a,'x')} ${fmtNum(b)}) + x \\cdot \\frac{${a}}{${fmt(a,'x')} ${fmtNum(b)}}`;
                    const denom = `x^2 ${fmtNum(c)}`;
                    const rawNum = `(${numDeriv})(${denom}) - ${num} \\cdot 2x`;
                    const ans = `f'(x) = \\frac{${rawNum}}{(${denom})^2}`;
                    const steps = `f'(x) &= \\frac{u'v - uv'}{v^2} \\\\
&= \\frac{${rawNum}}{(${denom})^2}`;
                    return {
                        q: `f(x) = \\frac{${num}}{${denom}}`,
                        a: `$$ ${ans} $$`,
                        steps: makeAlignedSteps(num, denom, numDeriv, `2x`, steps),
                        hint: "Produkt med logaritme - bruk produktregel f√∏rst."
                    };
                });

                patterns.push(() => {
                    // ln(ax^2 + b)/(cx + d) - logarithm of quadratic over linear
                    const c = r(1, 2);
                    const d = r(1, 3) * (Math.random() > 0.5 ? 1 : -1);
                    const num = `\\ln(${fmt(a,'x^2')} ${fmtNum(b)})`;
                    const numDeriv = `\\frac{${2*a}x}{${fmt(a,'x^2')} ${fmtNum(b)}}`;
                    const denom = `${fmt(c,'x')} ${fmtNum(d)}`;
                    const rawNum = `${numDeriv}(${denom}) - ${num} \\cdot ${c}`;
                    const ans = `f'(x) = \\frac{${rawNum}}{(${denom})^2}`;
                    const steps = `f'(x) &= \\frac{u'v - uv'}{v^2} \\\\
&= \\frac{${rawNum}}{(${denom})^2}`;
                    return {
                        q: `f(x) = \\frac{${num}}{${denom}}`,
                        a: `$$ ${ans} $$`,
                        steps: makeAlignedSteps(num, denom, numDeriv, `${c}`, steps),
                        hint: "Logaritme av kvadratisk over line√¶rt."
                    };
                });
            }

            const pattern = patterns[r(0, patterns.length - 1)];
            const prob = pattern();
            add('quotient', lvl, 'log', prob.q, prob.a, prob.steps, prob.hint);
        }

        function generateSingleProblem(rule, lvl, type, add) {
            const r = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
            const maxC = lvl * 2;
            const a = r(1, maxC) * (Math.random() > 0.8 && lvl > 1 ? -1 : 1);
            const b = r(1, maxC);
            const n = r(2, 2 + lvl);

            const par = (val) => val < 0 ? `(${val})` : val;

            // --- CHAIN RULE ---
            if (rule === 'chain') {
               let gu_tex = "", u_tex = "", gpu_tex = "", up_tex = "", subst_tex = "", final_tex = "", q = "", hint = "";
               let u_val = `${fmt(a,'x')} ${fmtNum(b)}`; 
               let up_val = `${a}`;

               if (type === 'poly') {
                    q = `f(x) = (${u_val})^${n}`;
                    gu_tex = `u^${n}`;
                    u_tex = u_val;
                    gpu_tex = `${n}u${fmtPow(n-1)}`;
                    up_tex = up_val;
                    subst_tex = `${n}(${u_val})${fmtPow(n-1)} \\cdot ${par(a)}`;
                    final_tex = `${n*a}(${u_val})${fmtPow(n-1)}`;
                    hint = "Potensregel med kjerne.";
                }
                else if (type === 'root') {
                    q = `f(x) = \\sqrt{${u_val}}`;
                    gu_tex = `\\sqrt{u}`;
                    u_tex = u_val;
                    gpu_tex = `\\frac{1}{2\\sqrt{u}}`;
                    up_tex = up_val;
                    subst_tex = `\\frac{1}{2\\sqrt{${u_val}}} \\cdot ${par(a)}`;
                    final_tex = `\\frac{${a}}{2\\sqrt{${u_val}}}`;
                    hint = "Kvadratrot-regel.";
                }
                else if (type === 'exp') {
                    q = `f(x) = e^{${u_val}}`;
                    gu_tex = `e^u`;
                    u_tex = u_val;
                    gpu_tex = `e^u`;
                    up_tex = up_val;
                    subst_tex = `e^{${u_val}} \\cdot ${par(a)}`;
                    final_tex = `${a}e^{${u_val}}`;
                    hint = "e^u regel.";
                }
                else if (type === 'log') {
                    q = `f(x) = \\ln(${u_val})`;
                    gu_tex = `\\ln u`;
                    u_tex = u_val;
                    gpu_tex = `\\frac{1}{u}`;
                    up_tex = up_val;
                    subst_tex = `\\frac{1}{${u_val}} \\cdot ${par(a)}`;
                    final_tex = `\\frac{${a}}{${u_val}}`;
                    hint = "ln(u) regel.";
                }

                const steps = `$$
\\begin{aligned}
g(u) &= ${gu_tex} & u(x) &= ${u_tex} \\\\
g'(u) &= ${gpu_tex} & u'(x) &= ${up_tex}
\\end{aligned}
$$
$$
\\begin{aligned}
f'(x) &= g'(u) \\cdot u'(x) \\\\
&= ${subst_tex} \\\\
&= ${final_tex}
\\end{aligned}
$$`;
                
                add(rule, lvl, type, q, `$$ f'(x) = ${final_tex} $$`, steps, hint);
            }

            // --- PRODUCT RULE ---
            else if (rule === 'product') {
                generateProductProblem(type, lvl, a, b, n, add);
            }
            
            // --- QUOTIENT RULE ---
            else if (rule === 'quotient') {
                generateQuotientProblem(type, lvl, a, b, n, add);
            }
        }

        function init() {
            const savedLang = localStorage.getItem('mathTrainerLang');
            if (savedLang) state.language = savedLang;
            
            // GENERATE PROBLEMS
            problemBank = generateProblemBank();

            updateLanguageUI();
            navigateTo('dashboard');
            renderChart();
        }

        function navigateTo(viewId) {
            state.currentView = viewId;
            
            // Hide all views
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            // Show target view
            document.getElementById(`view-${viewId}`).classList.remove('hidden');
            
            // Update Nav State
            document.querySelectorAll('.nav-item').forEach(el => {
                if(el.id === `nav-${viewId}`) {
                    el.classList.add('bg-blue-50', 'text-blue-700');
                    el.classList.remove('text-stone-600');
                } else {
                    el.classList.remove('bg-blue-50', 'text-blue-700');
                    el.classList.add('text-stone-600');
                }
            });

            // View Specific Logic
            if (viewId === 'theory') {
                const sel = document.getElementById('theory-topic-select');
                if(sel) {
                    // Sync dropdown with state, or default to chain if empty
                    sel.value = state.activeTopic || 'chain'; 
                }
                renderTheory();
            }
            
            if (viewId === 'practice') {
                if(state.activeProblems.length === 0) {
                    state.mode = 'focus';
                    renderModeUI();
                }
                renderProblems();
            }
            
            if (viewId === 'stats') updateChartData();

            // Re-render math
            if (window.MathJax) MathJax.typeset();
        }

        function startFocusMode() {
            state.mode = 'focus';
            if(!state.activeTopic) state.activeTopic = 'chain';
            state.activeProblems = []; 
            navigateTo('practice');
            renderModeUI();
            updateFilterCount();
        }

        function startMixMode() {
            state.mode = 'mix';
            updateProblemSet();
            navigateTo('practice');
        }

        function setMode(mode) {
            state.mode = mode;
            state.activeProblems = []; 
            if (mode === 'mix') updateProblemSet();
            renderModeUI();
            renderProblems();
            if(mode === 'focus') {
                const sel = document.getElementById('focus-rule-select');
                if(sel) sel.value = state.activeTopic;
                updateFilterCount();
            }
        }

        function changeFocusRule(topic) {
            state.activeTopic = topic;
            state.activeProblems = [];
            renderProblems(); 
            updateFilterCount(); 
        }

        function toggleFilter(category, value) {
            const list = state.filters[category + 's']; 
            const index = list.indexOf(value);
            if (index === -1) list.push(value);
            else list.splice(index, 1);
            updateFilterCount();
        }

        function updateFilterCount() {
            const matches = problemBank.filter(p => 
                p.topic === state.activeTopic &&
                state.filters.levels.includes(p.level) &&
                state.filters.types.includes(p.type)
            );
            document.getElementById('filter-count').textContent = matches.length;
        }

        function applyFiltersAndDraw() {
            let candidates = problemBank.filter(p => 
                p.topic === state.activeTopic &&
                state.filters.levels.includes(p.level) &&
                state.filters.types.includes(p.type)
            );
            
            if (candidates.length === 0) {
                alert("Ingen oppgaver funnet med disse filtrene.");
                return;
            }

            candidates.sort(() => 0.5 - Math.random());
            state.activeProblems = candidates.slice(0, 5);
            state.activeProblems.sort((a, b) => a.level - b.level);
            
            renderProblems();
        }

        // Helper function to get topic statistics
        function getTopicStats(topic) {
            let mastered = 0;
            let practice = 0;
            let total = 0;

            problemBank.forEach(p => {
                if (p.topic === topic) {
                    total++;
                    const status = state.progress[p.id];
                    if (status === 'mastered') mastered++;
                    if (status === 'practice') practice++;
                }
            });

            return { mastered, practice, total, attempted: mastered + practice };
        }

        // Helper function to get mastery level for a topic (0-1 scale)
        function getTopicMasteryLevel(topic) {
            const stats = getTopicStats(topic);
            if (stats.attempted === 0) return 0;
            return stats.mastered / stats.attempted;
        }

        // Helper function to identify struggling topics
        function getStrugglingTopics() {
            const topics = ['chain', 'product', 'quotient'];
            const struggling = [];

            topics.forEach(topic => {
                const stats = getTopicStats(topic);
                // A topic is "struggling" if:
                // - User has attempted at least 3 tasks AND
                // - More than 30% are marked as 'practice' OR mastery rate < 60%
                if (stats.attempted >= 3) {
                    const practiceRate = stats.practice / stats.attempted;
                    const masteryRate = stats.mastered / stats.attempted;
                    if (practiceRate > 0.3 || masteryRate < 0.6) {
                        struggling.push(topic);
                    }
                }
            });

            return struggling;
        }

        // Helper function to check if a problem is recommended
        function isRecommended(problem) {
            const strugglingTopics = getStrugglingTopics();
            return strugglingTopics.includes(problem.topic);
        }

        // Helper function to get preferred difficulty for a topic
        function getPreferredDifficultyForTopic(topic) {
            const stats = getTopicStats(topic);
            if (stats.attempted < 3) return 1; // Start easy for new topics

            const masteryRate = stats.mastered / stats.attempted;

            // If mastery is high (>70%), prefer higher difficulty
            if (masteryRate > 0.7) return 3;
            // If mastery is medium (40-70%), prefer medium difficulty
            if (masteryRate > 0.4) return 2;
            // If struggling (<40%), prefer lower difficulty
            return 1;
        }

        function getProblemWeight(problem) {
            const status = state.progress[problem.id];
            let weight = 1;

            // Exclude already completed tasks (mastered or practice) from smart mix
            // Users should only see new, unrated tasks
            if (status === 'mastered' || status === 'practice') {
                return 0;
            }

            // Reduce weight for recently shown tasks
            if (state.recentlyShown.includes(problem.id)) {
                weight *= 0.1;
            }

            // Boost weight for recommended tasks from struggling topics
            if (isRecommended(problem)) {
                weight *= 3; // Higher boost to make recommended tasks more prominent
            }

            // Adaptive difficulty: adjust weight based on topic mastery and problem difficulty
            const preferredDifficulty = getPreferredDifficultyForTopic(problem.topic);
            const difficultyDiff = Math.abs(problem.level - preferredDifficulty);

            // Reduce weight if difficulty is far from preferred level
            if (difficultyDiff > 1) {
                weight *= 0.5;
            }

            return weight;
        }

        function updateProblemSet() {
            if (state.mode === 'mix') {
                // Calculate weights for all problems
                let weighted = problemBank.map(p => ({ ...p, weight: getProblemWeight(p) }));

                // Sort by weight with randomization (weighted random shuffle)
                weighted.sort((a, b) => (b.weight * Math.random()) - (a.weight * Math.random()));

                // Select top 5 problems
                let selected = weighted.slice(0, 5);

                // Sort selected by difficulty level (ascending)
                selected.sort((a, b) => a.level - b.level);

                // Update active problems
                state.activeProblems = selected;

                // Track recently shown tasks (keep last 20 tasks in history)
                const newIds = selected.map(p => p.id);
                state.recentlyShown = [...newIds, ...state.recentlyShown].slice(0, 20);
                localStorage.setItem('mathTrainerRecentlyShown', JSON.stringify(state.recentlyShown));
            }
        }

        function renderModeUI() {
            const focusBtn = document.getElementById('mode-focus-btn');
            const mixBtn = document.getElementById('mode-mix-btn');
            const focusPanel = document.getElementById('focus-filter-panel');
            const titleEl = document.getElementById('practice-title');
            const ruleSel = document.getElementById('focus-rule-select');
            
            if(state.mode === 'focus') {
                focusBtn.className = "px-3 py-1 text-xs font-bold rounded transition-all bg-blue-600 text-white shadow-sm";
                mixBtn.className = "px-3 py-1 text-xs font-bold rounded transition-all text-stone-500 hover:bg-stone-100";
                focusPanel.classList.remove('hidden');
                if(ruleSel) ruleSel.value = state.activeTopic;
                titleEl.textContent = i18n[state.language].dash_focus_header;
            } else {
                mixBtn.className = "px-3 py-1 text-xs font-bold rounded transition-all bg-purple-600 text-white shadow-sm";
                focusBtn.className = "px-3 py-1 text-xs font-bold rounded transition-all text-stone-500 hover:bg-stone-100";
                focusPanel.classList.add('hidden');
                titleEl.textContent = i18n[state.language].mode_mix_title;
            }
        }

        function renderTheory() {
            const sel = document.getElementById('theory-topic-select');
            // Fallback to state topic if select is not yet available or has no value
            let topic = state.activeTopic;
            if (sel && sel.value) {
                topic = sel.value;
            }

            // Ensure we have a valid topic context
            if (!theoryData[topic]) topic = 'chain';

            const content = theoryData[topic][state.language];
            const container = document.getElementById('theory-content');

            container.innerHTML = `
                <h3 class="text-xl font-bold text-stone-800 mb-4">${content.title}</h3>
                <p class="text-stone-600 mb-6 leading-relaxed">${content.intro}</p>

                <div class="bg-blue-50 border border-blue-100 p-6 rounded-lg mb-6 text-center overflow-x-auto">
                    <span class="text-xs font-bold text-blue-400 uppercase tracking-wider mb-2 block">${i18n[state.language].theory_formula}</span>
                    <div class="text-lg text-stone-800 font-serif whitespace-nowrap">${content.formula}</div>
                </div>

                <p class="text-stone-500 italic text-center mb-8 border-l-4 border-stone-200 pl-4">${content.ruleText}</p>

                ${content.whenToUse || ''}

                ${content.detailedExample || ''}
            `;
            if(window.MathJax) MathJax.typeset();
        }

        function renderProblems() {
            const container = document.getElementById('problems-container');
            const texts = i18n[state.language];
            container.innerHTML = '';
            
            const list = state.activeProblems;

            if(list.length === 0) {
                if(state.mode === 'focus') {
                    container.innerHTML = `<div class="text-center text-stone-400 py-12"><i class="fa-solid fa-filter mb-2 text-2xl"></i><p>${texts.btn_draw_focus}...</p></div>`;
                }
                return;
            }

            list.forEach(prob => {
                const status = state.progress[prob.id];
                let borderClass = "border-stone-200";
                let icon = "";
                
                if(status === 'mastered') { borderClass = "border-emerald-500 border-l-4"; icon = '<i class="fa-solid fa-check text-emerald-500"></i>'; }
                else if(status === 'practice') { borderClass = "border-amber-500 border-l-4"; }

                let typeBadge = "";
                if(prob.type === 'poly') typeBadge = "Polynom";
                if(prob.type === 'root') typeBadge = "Rot";
                if(prob.type === 'exp') typeBadge = "Eksponential";
                if(prob.type === 'log') typeBadge = "Logaritme";
                
                let labelsHTML = '';
                if (state.mode === 'mix') {
                     // Check if this task is recommended (from a struggling topic)
                     const recommended = isRecommended(prob);
                     if (recommended) {
                         labelsHTML = `<span class="bg-amber-100 text-amber-700 px-2 py-1 rounded font-bold"><i class="fa-solid fa-star mr-1"></i>${texts.label_recommended}</span>`;
                     } else {
                         labelsHTML = `<span class="bg-purple-100 text-purple-600 px-2 py-1 rounded">${texts.label_mix}</span>`;
                     }
                } else {
                    labelsHTML = `
                        <span class="bg-stone-100 text-stone-500 px-2 py-1 rounded">Niv√• ${prob.level}</span>
                        <span class="bg-blue-50 text-blue-600 px-2 py-1 rounded">${typeBadge}</span>
                    `;
                }

                const div = document.createElement('div');
                div.className = `bg-white rounded-lg border shadow-sm p-6 ${borderClass}`;
                div.innerHTML = `
                    <div class="flex justify-between mb-4">
                        <div class="flex gap-2 text-[10px] font-bold uppercase tracking-wide">
                            ${labelsHTML}
                        </div>
                        ${icon}
                    </div>
                    <div class="text-xl font-serif text-center mb-6">$$${prob.q}$$</div>
                    <div class="flex justify-center gap-3">
                        <button onclick="toggleHint(${prob.id})" id="btn-hint-${prob.id}" class="text-stone-500 text-sm hover:text-amber-600 border border-stone-200 px-3 py-1.5 rounded bg-white"><i class="fa-regular fa-lightbulb mr-1"></i> ${texts.btn_hint}</button>
                        <button onclick="toggleSolution(${prob.id})" id="btn-sol-${prob.id}" class="text-white text-sm font-bold bg-blue-600 hover:bg-blue-700 px-3 py-1.5 rounded shadow-sm"><i class="fa-regular fa-eye mr-1"></i> ${texts.btn_solution}</button>
                    </div>
                    <div id="hint-${prob.id}" class="hidden mt-4 bg-amber-50 text-amber-800 p-3 rounded text-sm border border-amber-100 flex gap-2">
                        <i class="fa-solid fa-info-circle mt-0.5"></i> <div><span class="font-bold block text-xs uppercase mb-1">${texts.hint_title}</span>${prob.hint}</div>
                    </div>
                    <div id="sol-${prob.id}" class="hidden mt-6 pt-6 border-t border-stone-100 bg-stone-50/30 -mx-6 px-6">
                        <div class="text-center text-lg font-serif text-stone-800 mb-2">${prob.a}</div>
                        <div class="text-sm text-stone-500 text-center mb-4">${prob.steps}</div>
                        <div class="flex justify-center gap-2 pb-2">
                            <button onclick="rateProblem(${prob.id}, 'practice')" class="px-3 py-1 text-xs font-bold text-amber-700 bg-amber-100 hover:bg-amber-200 rounded">${texts.btn_practice}</button>
                            <button onclick="rateProblem(${prob.id}, 'mastered')" class="px-3 py-1 text-xs font-bold text-emerald-700 bg-emerald-100 hover:bg-emerald-200 rounded">${texts.btn_mastered}</button>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });

            const footer = document.createElement('div');
            footer.className = "mt-12 text-center border-t border-stone-200 pt-8";
            const btnText = state.mode === 'mix' ? texts.btn_new_mix : texts.btn_new_focus;
            const descText = state.mode === 'mix' ? texts.mix_end_text : texts.focus_end_text;
            const action = state.mode === 'mix' ? 'startMixMode()' : 'applyFiltersAndDraw()';
            
            footer.innerHTML = `
                <p class="text-stone-500 mb-4 text-sm">${descText}</p>
                <button onclick="${action}" class="bg-stone-800 text-white px-6 py-3 rounded-lg font-bold shadow-md hover:bg-black transition-transform hover:scale-105">
                    <i class="fa-solid fa-rotate mr-2"></i> ${btnText}
                </button>
            `;
            container.appendChild(footer);

            if(window.MathJax) MathJax.typeset();
        }

        function toggleHint(id) {
            const el = document.getElementById(`hint-${id}`);
            if(el.classList.contains('hidden')) {
                el.classList.remove('hidden');
                if(!state.hints.includes(id)) {
                    state.hints.push(id);
                    localStorage.setItem('mathTrainerHints', JSON.stringify(state.hints));
                }
            } else {
                el.classList.add('hidden');
            }
        }

        function toggleSolution(id) {
            const el = document.getElementById(`sol-${id}`);
            el.classList.toggle('hidden');
            if(!el.classList.contains('hidden') && window.MathJax) MathJax.typeset();
        }

        function rateProblem(id, status) {
            state.progress[id] = status;
            localStorage.setItem('mathTrainerProgress', JSON.stringify(state.progress));
            renderProblems();
        }

        function clearProgress() {
            const texts = i18n[state.language];
            if (confirm(texts.clear_confirm)) {
                // Clear all progress data from state
                state.progress = {};
                state.hints = [];
                state.recentlyShown = [];
                state.activeProblems = [];

                // Clear all localStorage items
                localStorage.removeItem('mathTrainerProgress');
                localStorage.removeItem('mathTrainerHints');
                localStorage.removeItem('mathTrainerRecentlyShown');

                // Update all views
                updateChartData();
                renderProblems();

                // Show success message
                alert('‚úì ' + (state.language === 'no' ? 'All fremgang er slettet' :
                              state.language === 'en' ? 'All progress has been cleared' :
                              state.language === 'es' ? 'Todo el progreso ha sido eliminado' :
                              '–í–µ—Å—å –ø—Ä–æ–≥—Ä–µ—Å –≤–∏–¥–∞–ª–µ–Ω–æ'));
            }
        }

        function setLanguage(lang) {
            state.language = lang;
            localStorage.setItem('mathTrainerLang', lang);
            updateLanguageUI();
            navigateTo(state.currentView);
        }

        function updateLanguageUI() {
            document.querySelectorAll('[data-key]').forEach(el => {
                const key = el.getAttribute('data-key');
                if (i18n[state.language][key]) {
                    el.textContent = i18n[state.language][key];
                }
            });
            
            const selTopic = document.getElementById('theory-topic-select');
            if(selTopic) {
                Array.from(selTopic.options).forEach(opt => {
                    const key = opt.getAttribute('data-key');
                    if(i18n[state.language][key]) opt.textContent = i18n[state.language][key];
                });
            }
            
            const selRule = document.getElementById('focus-rule-select');
            if(selRule) {
                Array.from(selRule.options).forEach(opt => {
                    const key = opt.getAttribute('data-key');
                    if(i18n[state.language][key]) opt.textContent = i18n[state.language][key];
                });
            }

            document.querySelectorAll('.lang-btn').forEach(btn => {
                if(btn.id === `btn-${state.language}`) {
                    btn.className = "lang-btn px-3 py-1 text-sm font-medium rounded-md transition-all bg-white shadow-sm ring-1 ring-black/10";
                } else {
                    btn.className = "lang-btn px-3 py-1 text-sm font-medium rounded-md transition-all text-stone-400 hover:bg-stone-200";
                }
            });
        }

        let chart1, chart2, chart3;
        function renderChart() {
            const ctx1 = document.getElementById('masteryChart').getContext('2d');
            chart1 = new Chart(ctx1, { type: 'doughnut', data: { datasets: [{ data: [1], backgroundColor: ['#eee'] }] } });
            const ctx2 = document.getElementById('topicChart').getContext('2d');
            chart2 = new Chart(ctx2, { type: 'bar', data: { datasets: [{ data: [] }] } });
            const ctx3 = document.getElementById('levelChart').getContext('2d');
            chart3 = new Chart(ctx3, { type: 'bar', data: { datasets: [{ data: [] }] } });
        }
        function updateChartData() {
            let mastered = 0;
            let practice = 0;
            const attemptedIds = [];

            Object.entries(state.progress).forEach(([id, val]) => {
                if(val === 'mastered') mastered++;
                if(val === 'practice') practice++;
                if(val === 'mastered' || val === 'practice') attemptedIds.push(parseInt(id));
            });

            const texts = i18n[state.language];

            // Only show attempted tasks (mastered + practice), not the full 1200 task bank
            chart1.data.labels = [texts.chart_mastered, texts.chart_practice];
            chart1.data.datasets[0].data = [mastered, practice];
            chart1.data.datasets[0].backgroundColor = ['#10b981', '#f59e0b'];
            chart1.update();

            const topics = ['chain', 'product', 'quotient'];
            const topicMastery = [0, 0, 0];
            const topicPractice = [0, 0, 0];

            const levelMastery = [0, 0, 0, 0, 0];
            const levelPractice = [0, 0, 0, 0, 0];

            problemBank.forEach(p => {
                const status = state.progress[p.id];
                const idx = topics.indexOf(p.topic);
                if(idx !== -1 && (status === 'mastered' || status === 'practice')) {
                    if(status === 'mastered') topicMastery[idx]++;
                    if(status === 'practice') topicPractice[idx]++;
                }
                if(p.level >= 1 && p.level <= 5 && (status === 'mastered' || status === 'practice')) {
                    if(status === 'mastered') levelMastery[p.level-1]++;
                    if(status === 'practice') levelPractice[p.level-1]++;
                }
            });

            chart2.data.labels = [texts.topic_chain, texts.topic_product, texts.topic_quotient];
            chart2.data.datasets[0].label = texts.chart_mastered;
            chart2.data.datasets[0].backgroundColor = '#10b981';
            chart2.data.datasets[0].data = topicMastery;
            if(chart2.data.datasets.length < 2) {
                 chart2.data.datasets.push({ label: texts.chart_practice, backgroundColor: '#f59e0b', data: topicPractice });
            } else {
                 chart2.data.datasets[1].label = texts.chart_practice;
                 chart2.data.datasets[1].data = topicPractice;
            }
            chart2.update();

            chart3.data.labels = ['Lvl 1', 'Lvl 2', 'Lvl 3', 'Lvl 4', 'Lvl 5'];
            chart3.data.datasets[0].label = texts.chart_mastered;
            chart3.data.datasets[0].backgroundColor = '#10b981';
            chart3.data.datasets[0].data = levelMastery;
            if(chart3.data.datasets.length < 2) {
                 chart3.data.datasets.push({ label: texts.chart_practice, backgroundColor: '#f59e0b', data: levelPractice });
            } else {
                 chart3.data.datasets[1].label = texts.chart_practice;
                 chart3.data.datasets[1].data = levelPractice;
            }
            chart3.update();

            const totalAttempted = mastered + practice;
            const relevantHints = state.hints.filter(hid => attemptedIds.includes(parseInt(hid))).length;
            const hintRate = totalAttempted > 0 ? Math.round((relevantHints / totalAttempted) * 100) : 0;
            const masteryRate = totalAttempted > 0 ? Math.round((mastered / totalAttempted) * 100) : 0;

            document.getElementById('stat-total-display').textContent = totalAttempted;
            document.getElementById('stat-mastery-display').textContent = masteryRate + '%';
            document.getElementById('stat-hint-display').textContent = hintRate + '%';
        }

        window.onload = init;
    </script>
</body>
</html>
